{% extends 'student/base.html' %}
{% load static %}

{% block title %}
Student -> Manage Hackathon Team
{% endblock %}

{% block body %}
<div class="container-fluid">
    <div class="card">
        <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h5 class="card-title fw-semibold">Manage Team: {{ team.name }}</h5>
                <a href="{% url 'hackathon_dashboard' %}" class="btn btn-outline-primary btn-sm">
                    <i class="ti ti-arrow-left"></i> Back to Dashboard
                </a>
            </div>

            {% for message in messages %}
            <div class="alert {{ message.tags }} alert-dismissible fade show" role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
            {% endfor %}

            <div class="row">
                <div class="col-md-8">
                    <div class="card border-0 shadow-sm mb-4">
                        <div class="card-body p-4">
                            <h6 class="fw-semibold mb-3">Team Details</h6>
                            <form id="update-team-form" method="post" action="{% url 'update_team' team.id %}">
                                {% csrf_token %}
                                <div class="mb-3">
                                    <label for="team-name" class="form-label">Team Name <span
                                            class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="team-name" name="name"
                                        value="{{ team.name }}" required>
                                </div>

                                <div class="mb-3">
                                    <label for="team-description" class="form-label">Team Description <span
                                            class="text-danger">*</span></label>
                                    <textarea class="form-control" id="team-description" name="description" rows="4"
                                        required>{{ team.description }}</textarea>
                                </div>

                                <div class="mb-3">
                                    <label for="members-limit" class="form-label">Team Members Limit</label>
                                    <input type="number" class="form-control" id="members-limit" name="members_limit"
                                        min="2" max="10" value="{{ team.members_limit }}">
                                    <div class="form-text">Maximum number of team members (including you as the leader).
                                    </div>
                                </div>

                                <div class="mb-3">
                                    <label for="team-status" class="form-label">Team Status</label>
                                    <select class="form-select" id="team-status" name="status">
                                        <option value="open" {% if team.status == 'open' %}selected{% endif %}>Open
                                            (Accepting new members)</option>
                                        <option value="in_progress" {% if team.status == 'in_progress' %}selected{% endif %}>In Progress
                                            (Working on project)</option>
                                        <option value="closed" {% if team.status == 'closed' %}selected{% endif %}>Closed
                                            (Not accepting new members)</option>
                                    </select>
                                </div>

                                <div class="mb-4">
                                    <label for="required-skills" class="form-label">Required Skills</label>
                                    <div class="input-group">
                                        <input type="text" class="form-control" id="skill-input"
                                            placeholder="Add a skill...">
                                        <button class="btn btn-outline-primary" type="button"
                                            id="add-skill-btn">Add</button>
                                    </div>
                                    <div class="form-text">Add skills that your team is looking for.</div>

                                    <div class="mt-2" id="skills-container">
                                        <!-- Skills will be added here dynamically -->
                                    </div>
                                    <input type="hidden" id="required-skills" name="required_skills"
                                        value="{{ team.required_skills|safe }}">
                                </div>

                                <div class="d-flex gap-2">
                                    <button type="submit" class="btn btn-primary">Update Team</button>
                                    <button type="button" class="btn btn-danger" id="delete-team-btn">Delete
                                        Team</button>
                                </div>
                            </form>
                        </div>
                    </div>

                    <div class="card border-0 shadow-sm mb-4">
                        <div class="card-body p-4">
                            <h6 class="fw-semibold mb-3">Team Members ({{ team.current_members_count }}/{{
                                team.members_limit }})</h6>

                            <div class="list-group">
                                <!-- Team Leader -->
                                <div class="list-group-item d-flex justify-content-between align-items-center">
                                    <div>
                                        <h6 class="mb-0">{{ team.leader.first_name }} {{ team.leader.last_name }}</h6>
                                        <small class="text-muted">Team Leader</small>
                                    </div>
                                    <span class="badge bg-primary">You</span>
                                </div>

                                <!-- Team Members -->
                                {% for member in team_members %}
                                <div class="list-group-item d-flex justify-content-between align-items-center"
                                    id="member-{{ member.id }}">
                                    <div>
                                        <h6 class="mb-0">{{ member.student.first_name }} {{ member.student.last_name }}
                                        </h6>
                                        <small class="text-muted">Joined {{ member.joined_at|timesince }} ago</small>
                                    </div>
                                    <button class="btn btn-sm btn-outline-danger remove-member-btn"
                                        data-member-id="{{ member.id }}">
                                        Remove
                                    </button>
                                </div>
                                {% empty %}
                                <div class="list-group-item text-center py-3">
                                    <p class="mb-0 text-muted">No team members yet</p>
                                </div>
                                {% endfor %}
                            </div>

                            {% if not team.is_full and team.status == 'open' %}
                            <div class="mt-3">
                                <button class="btn btn-primary w-100" data-bs-toggle="modal"
                                    data-bs-target="#inviteModal">
                                    <i class="ti ti-user-plus"></i> Invite Members
                                </button>
                            </div>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Sent Invites -->
                    <div class="card border-0 shadow-sm mb-4">
                        <div class="card-body p-4">
                            <h6 class="fw-semibold mb-3">Sent Invites ({{ sent_invites.count }})</h6>

                            <div class="list-group" id="sent-invites-list">
                                {% for invite in sent_invites %}
                                <div class="list-group-item" id="invite-{{ invite.id }}">
                                    <div class="d-flex w-100 justify-content-between align-items-start mb-2">
                                        <h6 class="mb-0">{{ invite.student.first_name }} {{ invite.student.last_name }}
                                        </h6>
                                        <small class="text-muted">{{ invite.created_at|timesince }} ago</small>
                                    </div>
                                    {% if invite.message %}
                                    <p class="mb-2 text-muted">{{ invite.message }}</p>
                                    {% endif %}
                                    <div class="d-flex gap-2 mt-2">
                                        <button class="btn btn-sm btn-danger cancel-invite-btn"
                                            data-invite-id="{{ invite.id }}">
                                            Cancel Invite
                                        </button>
                                    </div>
                                </div>
                                {% empty %}
                                <div class="list-group-item text-center py-3">
                                    <p class="mb-0 text-muted">No pending invites</p>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-md-4">
                    <div class="card border-0 shadow-sm">
                        <div class="card-body p-4">
                            <h6 class="fw-semibold mb-3">Join Requests ({{ join_requests.count }})</h6>

                            <div class="list-group" id="join-requests-list">
                                {% for request in join_requests %}
                                <div class="list-group-item" id="request-{{ request.id }}">
                                    <div class="d-flex w-100 justify-content-between align-items-start mb-2">
                                        <h6 class="mb-0">{{ request.student.first_name }} {{ request.student.last_name
                                            }}</h6>
                                        <small class="text-muted">{{ request.created_at|timesince }} ago</small>
                                    </div>
                                    {% if request.message %}
                                    <p class="mb-2 text-muted">{{ request.message }}</p>
                                    {% endif %}
                                    <div class="d-flex gap-2 mt-2">
                                        <button class="btn btn-sm btn-success approve-request-btn"
                                            data-request-id="{{ request.id }}">
                                            Approve
                                        </button>
                                        <button class="btn btn-sm btn-danger reject-request-btn"
                                            data-request-id="{{ request.id }}">
                                            Reject
                                        </button>
                                    </div>
                                </div>
                                {% empty %}
                                <div class="list-group-item text-center py-3">
                                    <p class="mb-0 text-muted">No pending join requests</p>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Delete Team Confirmation Modal -->
<div class="modal fade" id="deleteTeamModal" tabindex="-1" aria-labelledby="deleteTeamModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteTeamModalLabel">Confirm Delete Team</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete your team? This action cannot be undone.</p>
                <p class="text-danger">All team members will be removed and all join requests will be deleted.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <form id="delete-team-form" method="post" action="{% url 'delete_team' team.id %}">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-danger">Delete Team</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Invite Members Modal -->
<div class="modal fade" id="inviteModal" tabindex="-1" aria-labelledby="inviteModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="inviteModalLabel">Invite Members</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="student-search" class="form-label">Search Students</label>
                    <input type="text" class="form-control" id="student-search"
                        placeholder="Search by name or email...">
                </div>

                <div id="search-results" class="list-group mb-3" style="max-height: 200px; overflow-y: auto;">
                    <!-- Search results will be added here dynamically -->
                </div>

                <div id="selected-student" class="d-none mb-3">
                    <label class="form-label">Selected Student</label>
                    <div class="card">
                        <div class="card-body">
                            <h6 class="card-title mb-1" id="selected-student-name"></h6>
                            <p class="card-text text-muted mb-0" id="selected-student-email"></p>
                        </div>
                    </div>
                    <input type="hidden" id="selected-student-id">
                </div>

                <div class="mb-3">
                    <label for="invite-message" class="form-label">Message (Optional)</label>
                    <textarea class="form-control" id="invite-message" name="message" rows="3"
                        placeholder="Add a personal message to your invite..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <form id="send-invite-form" method="post" action="{% url 'send_team_invite' team.id %}">
                    {% csrf_token %}
                    <input type="hidden" id="selected-student-id" name="student_id">
                    <textarea class="form-control" id="invite-message" name="message" rows="3"
                        placeholder="Add a personal message to your invite..."></textarea>
                    <button type="submit" class="btn btn-primary" id="send-invite-btn" disabled>Send Invite</button>
                </form>
            </div>
        </div>
    </div>
</div>

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Initialize DOM elements
        const updateTeamForm = document.getElementById('update-team-form');
        const skillInput = document.getElementById('skill-input');
        const addSkillBtn = document.getElementById('add-skill-btn');
        const skillsContainer = document.getElementById('skills-container');
        const requiredSkillsInput = document.getElementById('required-skills');
        const deleteTeamBtn = document.getElementById('delete-team-btn');
        const deleteTeamForm = document.getElementById('delete-team-form');
        const sendInviteForm = document.getElementById('send-invite-form');

        // Initialize skills array from existing skills
        let skills = [];
        try {
            skills = JSON.parse(requiredSkillsInput.value || '[]');
        } catch (e) {
            console.error('Error parsing skills:', e);
            skills = [];
        }

        // Display initial skills
        updateSkillsDisplay();

        // Function to update skills display
        function updateSkillsDisplay() {
            skillsContainer.innerHTML = '';
            skills.forEach((skill, index) => {
                const skillBadge = document.createElement('span');
                skillBadge.className = 'badge bg-primary me-2 mb-2';
                skillBadge.innerHTML = `${skill} <i class="ti ti-x ms-1" style="cursor: pointer;" data-index="${index}"></i>`;
                skillsContainer.appendChild(skillBadge);
            });

            // Update hidden input
            requiredSkillsInput.value = JSON.stringify(skills);
        }

        // Add skill when button is clicked
        addSkillBtn.addEventListener('click', function () {
            const skill = skillInput.value.trim();
            if (skill && !skills.includes(skill)) {
                skills.push(skill);
                updateSkillsDisplay();
                skillInput.value = '';
            }
            skillInput.focus();
        });

        // Add skill when Enter key is pressed
        skillInput.addEventListener('keypress', function (e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                addSkillBtn.click();
            }
        });

        // Remove skill when X is clicked
        skillsContainer.addEventListener('click', function (e) {
            if (e.target.tagName === 'I') {
                const index = parseInt(e.target.getAttribute('data-index'));
                skills.splice(index, 1);
                updateSkillsDisplay();
            }
        });

        // Handle update team form submission
        updateTeamForm.addEventListener('submit', function (e) {
            e.preventDefault();
            this.submit();
        });

        // Handle delete team button click
        deleteTeamBtn.addEventListener('click', function () {
            // Show delete confirmation modal
            const deleteTeamModal = new bootstrap.Modal(document.getElementById('deleteTeamModal'));
            deleteTeamModal.show();
        });

        // Handle send invite button click
        sendInviteForm.addEventListener('submit', function (e) {
            e.preventDefault();
            this.submit();
        });

        // Handle student search
        let searchTimeout;
        studentSearch.addEventListener('input', function () {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                const query = this.value.trim();
                if (query.length >= 2) {
                    searchStudents(query);
                } else {
                    searchResults.innerHTML = '';
                }
            }, 300);
        });

        // Function to search students
        function searchStudents(query) {
            fetch(`/student/hackathon/search-students/?query=${encodeURIComponent(query)}&team_id={{ team.id }}`, {
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        searchResults.innerHTML = '';

                        if (data.results.length === 0) {
                            searchResults.innerHTML = `
                            <div class="list-group-item text-center py-3">
                                <p class="mb-0 text-muted">No students found</p>
                            </div>
                        `;
                            return;
                        }

                        data.results.forEach(student => {
                            const item = document.createElement('button');
                            item.type = 'button';
                            item.className = 'list-group-item list-group-item-action';
                            item.innerHTML = `
                            <h6 class="mb-1">${student.name}</h6>
                            <small class="text-muted">${student.email}</small>
                        `;
                            item.addEventListener('click', () => selectStudent(student));
                            searchResults.appendChild(item);
                        });
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showToast('An error occurred while searching students.', 'error');
                });
        }

        // Function to select a student
        function selectStudent(student) {
            selectedStudentName.textContent = student.name;
            selectedStudentEmail.textContent = student.email;
            selectedStudentId.value = student.id;
            selectedStudent.classList.remove('d-none');
            searchResults.innerHTML = '';
            studentSearch.value = '';
            sendInviteBtn.disabled = false;
        }

        // Reset invite modal when closed
        document.getElementById('inviteModal').addEventListener('hidden.bs.modal', function () {
            studentSearch.value = '';
            searchResults.innerHTML = '';
            selectedStudent.classList.add('d-none');
            inviteMessage.value = '';
            sendInviteBtn.disabled = true;
        });

        // Function to show toast notification
        function showToast(message, type) {
            if (typeof toastr !== 'undefined') {
                toastr[type](message);
            } else {
                alert(message);
            }
        }

        // Function to get CSRF token from cookies
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
    });
</script>
{% endblock %}

{% endblock %}