{% extends "student/base.html" %}
{% load static %}

{% block title %}
Leaderboard | {{ batch.name }}
{% endblock %}

{% block my_batches_active %}
active
{% endblock %}

{% block body %}

<div class="container-fluid">
    <div class="card">
        <div class="card-body">
            <h3 class="heading">
                <span class="fw-semibold">{{ batch.name }}'s LeaderboardðŸ”¥</span>
            </h3>


        </div>
    </div>


    {% for message in messages %}

    <div class="alert {{ message.tags }} alert-dismissible fade show" role="alert">
        <strong>{{ message.tag }}</strong> {{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>

    {% endfor %}


    <!-- <div class="card w-100">
        <div class="card-body p-4">
            <form method="post">

                {% csrf_token %}

                <div class="input-group">
                    <input type="text" class="form-control" placeholder="Search by ID, Name, Email or Phone Number"
                        aria-label="Search by ID, Name, Email or Phone Number" aria-describedby="button-addon2"
                        name="query">
                    <button class="btn btn-outline-secondary" type="submit" id="button-addon2">Search</button>
                    <a href="#" class="btn btn-outline-danger">Clear</a>
                </div>
            </form>
        </div>
    </div> -->

    <div class="card w-100">
        <div class="card-body p-4">
            <h5 class="card-title fw-semibold mb-4">Leaderboard ðŸ”¥
                {% if query %}
                <span class="fs-6"> | Search Results for "{{ query }}"</span>
                {% endif %}
            </h5>
            <div class="table-responsive">
                <table class="table text-nowrap mb-0 align-middle">
                    <thead class="text-dark fs-4">
                        <tr>
                            <th class="border-bottom-0">
                                <h6 class="fw-semibold mb-0">Rank</h6>
                            </th>
                            <th class="border-bottom-0">
                                <h6 class="fw-semibold mb-0">Student</h6>
                            </th>
                            <th class="border-bottom-0">
                                <h6 class="fw-semibold mb-0">Total Score</h6>
                            </th>
                            <th class="border-bottom-0">
                                <h6 class="fw-semibold mb-0">Earliest Submission</h6>
                            </th>
                            <th class="border-bottom-0">
                                <h6 class="fw-semibold mb-0">Solved Problems</h6>
                            </th>
                            <th class="border-bottom-0">
                                <h6 class="fw-semibold mb-0">Sheet Breakdown</h6>
                            </th>
                        </tr>
                    </thead>

                    <tbody id="leaderboard">

                    </tbody>
                </table>
            </div>

            <!-- Pagination controls -->
            <div id="pagination-container" class="mt-4"></div>

        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const leaderboardContainer = document.getElementById('leaderboard');
            const filterForm = document.getElementById('filter-form');
            const apiUrl = "{% url 'student_fetch_batch_leaderboard' batch.slug %}";

            let currentPage = 1;
            let totalPages = 1;

            leaderboardContainer.innerHTML = `
                        <tr>
                            <td colspan="6" class="text-center">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                            </td>
                        </tr>`

            async function fetchLeaderboard(page = 1) {
                // Show loading state
                leaderboardContainer.innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </td>
                    </tr>`;

                const response = await fetch(`${apiUrl}?page=${page}&page_size=10`);
                const data = await response.json();
                console.log(data);

                currentPage = data.pagination.current_page;
                totalPages = data.pagination.total_pages;

                renderLeaderboard(data.leaderboard);
                renderPagination(data.pagination);
            }

            function renderLeaderboard(leaderboard) {
                leaderboardContainer.innerHTML = '';

                if (leaderboard.length === 0) {
                    leaderboardContainer.innerHTML = `
                        <tr>
                            <td colspan="6" class="text-center text-muted">No leaderboard data available</td>
                        </tr>`;
                    return;
                }

                leaderboard.forEach((entry) => {
                    let sheetDetails = '';
                    for (const [sheet, count] of Object.entries(entry.sheet_breakdown)) {
                        sheetDetails += `<p class="mb-0"><strong>${sheet}:</strong> ${count}</p>`;
                    }

                    const row = `
                    <tr>
                        <td class="border-bottom-0">
                            <p class="fw-semibold mb-0">${entry.rank}</p>
                        </td>
                        <td class="border-bottom-0">
                            <p class="fw-semibold mb-0">${entry.student.name}</p>
                        </td>
                        <td class="border-bottom-0">
                            <p class="fw-semibold mb-0">${entry.total_score}</p>
                        </td>
                        <td class="border-bottom-0">
                            <p class="fw-semibold mb-0">${new Date(entry.earliest_submission).toLocaleString()}</p>
                        </td>
                        <td class="border-bottom-0">
                            <p class="fw-semibold mb-0">${entry.solved_problems}</p>
                        </td>
                        <td class="border-bottom-0">
                            <div class="text-muted small">
                                ${sheetDetails || '<p class="mb-0">No sheets solved</p>'}
                            </div>
                        </td>
                    </tr>
                    `;
                    leaderboardContainer.innerHTML += row;
                });
            }

            function renderPagination(pagination) {
                const paginationContainer = document.getElementById('pagination-container');
                if (!paginationContainer) return;

                if (pagination.total_pages <= 1) {
                    paginationContainer.innerHTML = '';
                    return;
                }

                let paginationHTML = '<nav aria-label="Leaderboard pagination"><ul class="pagination justify-content-center mb-0">';

                // Previous button
                paginationHTML += `
                    <li class="page-item ${!pagination.has_previous ? 'disabled' : ''}">
                        <button class="page-link" onclick="changePage(${pagination.current_page - 1})" ${!pagination.has_previous ? 'disabled' : ''}>
                            Previous
                        </button>
                    </li>`;

                // Page numbers (show max 5 pages at a time)
                const maxPagesToShow = 5;
                let startPage = Math.max(1, pagination.current_page - Math.floor(maxPagesToShow / 2));
                let endPage = Math.min(pagination.total_pages, startPage + maxPagesToShow - 1);

                if (endPage - startPage < maxPagesToShow - 1) {
                    startPage = Math.max(1, endPage - maxPagesToShow + 1);
                }

                // First page
                if (startPage > 1) {
                    paginationHTML += `
                        <li class="page-item">
                            <button class="page-link" onclick="changePage(1)">1</button>
                        </li>`;
                    if (startPage > 2) {
                        paginationHTML += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
                    }
                }

                // Page numbers
                for (let i = startPage; i <= endPage; i++) {
                    paginationHTML += `
                        <li class="page-item ${i === pagination.current_page ? 'active' : ''}">
                            <button class="page-link" onclick="changePage(${i})">${i}</button>
                        </li>`;
                }

                // Last page
                if (endPage < pagination.total_pages) {
                    if (endPage < pagination.total_pages - 1) {
                        paginationHTML += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
                    }
                    paginationHTML += `
                        <li class="page-item">
                            <button class="page-link" onclick="changePage(${pagination.total_pages})">${pagination.total_pages}</button>
                        </li>`;
                }

                // Next button
                paginationHTML += `
                    <li class="page-item ${!pagination.has_next ? 'disabled' : ''}">
                        <button class="page-link" onclick="changePage(${pagination.current_page + 1})" ${!pagination.has_next ? 'disabled' : ''}>
                            Next
                        </button>
                    </li>`;

                paginationHTML += '</ul></nav>';

                // Add page info
                paginationHTML += `
                    <div class="text-center mt-3 text-muted">
                        <small>Showing page ${pagination.current_page} of ${pagination.total_pages} (${pagination.total_count} total students)</small>
                    </div>`;

                paginationContainer.innerHTML = paginationHTML;
            }

            // Global function for pagination buttons
            window.changePage = function (page) {
                if (page >= 1 && page <= totalPages) {
                    fetchLeaderboard(page);
                    // Scroll to top of table
                    document.querySelector('.card').scrollIntoView({ behavior: 'smooth' });
                }
            };

            const start = performance.now();

            fetchLeaderboard(); // Initial fetch

            const end = performance.now();
            console.log(`Leaderboard fetched and rendered in ${end - start} ms`);
        });

    </script>


    {% endblock %}