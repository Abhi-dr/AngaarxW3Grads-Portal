{% extends 'student/base.html' %}

{% load custom_filters %}

{% block my_batches_active %}
active
{% endblock %}

{% block title %}
Dashboard | My Courses
{% endblock %}

{% block extra_css %}

<style>
    .transition-icon {
        transition: transform 0.3s ease;
    }
    
    .card-header[aria-expanded="true"] .transition-icon {
        transform: rotate(180deg);
    }
    
    .collapse {
        transition: height 0.35s ease;
    }
    
    /* College Dropdown Styling - Dark Mode Compatible */
    .college-dropdown {
        padding: 0.4rem 0.5rem;
        border: 1.5px solid rgba(255, 255, 255, 0.2);
        border-radius: 0.5rem;
        font-size: 0.9rem;
        transition: all 0.3s ease;
        max-height: 200px;
        overflow-y: auto;
        background-color: rgba(255, 255, 255, 0.05);
        color: inherit;
        scrollbar-width: thin;
        scrollbar-color: rgba(255, 255, 255, 0.3) transparent;
    }
    
    .college-dropdown::-webkit-scrollbar {
        width: 6px;
    }
    
    .college-dropdown::-webkit-scrollbar-track {
        background: transparent;
    }
    
    .college-dropdown::-webkit-scrollbar-thumb {
        background-color: rgba(255, 255, 255, 0.3);
        border-radius: 10px;
    }
    
    .college-dropdown:focus {
        border-color: #0d6efd;
        box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
        outline: none;
        background-color: rgba(255, 255, 255, 0.08);
    }
    
    .college-dropdown option {
        padding: 0.6rem;
        cursor: pointer;
        background-color: var(--bs-body-bg, #212529);
        
    }

    [data-bs-theme="dark"] select>option {
    color: #ffffff;
    }
    
    .college-dropdown option:hover,
    .college-dropdown option:checked {
        background-color: rgba(13, 110, 253, 0.2);
    }
    
    .college-dropdown option[value="other"] {
        border-top: 1px solid rgba(255, 255, 255, 0.2);
        margin-top: 0.25rem;
        padding-top: 0.75rem;
        font-weight: 600;
        color: #0d6efd;
        background: linear-gradient(135deg, rgba(13, 110, 253, 0.1), rgba(13, 110, 253, 0.05));
    }
    
    /* Custom Input for Manual Entry */
    .college-custom-input {
        border: 2px solid #28a745;
        border-radius: 0.5rem;
        padding: 0.65rem 0.75rem;
        font-size: 0.95rem;
        transition: all 0.3s ease;
        background-color: rgba(40, 167, 69, 0.08);
        color: inherit;
    }
    
    .college-custom-input:focus {
        border-color: #28a745;
        box-shadow: 0 0 0 0.25rem rgba(40, 167, 69, 0.25);
        outline: none;
        background-color: rgba(40, 167, 69, 0.12);
    }
    
    .college-custom-input::placeholder {
        color: rgba(255, 255, 255, 0.5);
        font-style: italic;
    }
    
    /* Invalid State Styling */
    .college-dropdown.is-invalid,
    .college-custom-input.is-invalid {
        border-color: #dc3545;
        animation: shake 0.3s ease;
    }
    
    .college-dropdown.is-invalid:focus,
    .college-custom-input.is-invalid:focus {
        border-color: #dc3545;
        box-shadow: 0 0 0 0.25rem rgba(220, 53, 69, 0.25);
    }
    
    @keyframes shake {
        0%, 100% { transform: translateX(0); }
        25% { transform: translateX(-5px); }
        75% { transform: translateX(5px); }
    }
    
    /* Search Input Styling - Dark Mode */
    .college-search-input {
        padding: 0.6rem 0.75rem;
        border: 1.5px solid rgba(255, 255, 255, 0.2);
        border-radius: 0.5rem;
        font-size: 0.9rem;
        transition: all 0.3s ease;
        background: rgba(255, 255, 255, 0.05);
        color: inherit;
    }
    
    .college-search-input:focus {
        border-color: #0d6efd;
        box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.15);
        outline: none;
        background: rgba(255, 255, 255, 0.08);
    }
    
    .college-search-input::placeholder {
        color: rgb(255, 255, 255);
    }
    
    .search-icon {
        color: rgba(255, 255, 255, 0.6);
    }
    
    /* Input Group Styling for Dark Mode */
    .input-group-text {
        background-color: rgba(255, 255, 255, 0.05);
        border-color: rgba(255, 255, 255, 0.2);
        color: inherit;
    }
    
    /* Results Count Badge */
    .search-results-badge {
        display: inline-block;
        padding: 0.25rem 0.5rem;
        font-size: 0.75rem;
        border-radius: 0.375rem;
        background: rgba(13, 110, 253, 0.2);
        color: #0d6efd;
        font-weight: 600;
        margin-left: 0.5rem;
    }

    /* ================================================ */
    /* IMAGE LAZY LOADING & OPTIMIZATION STYLES */
    /* ================================================ */
    
    /* Skeleton Loader for Images */
    .image-skeleton {
        position: relative;
        overflow: hidden;
        background: linear-gradient(
            90deg,
            rgba(255, 255, 255, 0.05) 25%,
            rgba(255, 255, 255, 0.1) 50%,
            rgba(255, 255, 255, 0.05) 75%
        );
        background-size: 200% 100%;
        animation: shimmer 1.5s infinite;
        min-height: 200px;
    }
    
    @keyframes shimmer {
        0% {
            background-position: -200% 0;
        }
        100% {
            background-position: 200% 0;
        }
    }
    
    /* Image Container for Lazy Loading */
    .lazy-image-container {
        position: relative;
        width: 100%;
        overflow: hidden;
        background-color: rgba(255, 255, 255, 0.05);
    }
    
    /* Lazy Load Images - Hidden Initially */
    .lazy-image {
        opacity: 0;
        transition: opacity 0.4s ease-in-out;
        width: 100%;
        height: auto;
        display: block;
    }
    
    /* Loaded State */
    .lazy-image.loaded {
        opacity: 1;
    }
    
    /* Error State for Broken Images */
    .lazy-image.error {
        opacity: 0.5;
        filter: grayscale(100%);
    }
    
    /* Placeholder for Missing Images */
    .image-placeholder {
        display: flex;
        align-items: center;
        justify-content: center;
        min-height: 200px;
        background: linear-gradient(135deg, rgba(255, 96, 38, 0.1), rgba(255, 79, 15, 0.1));
        color: rgba(255, 255, 255, 0.5);
        font-size: 3rem;
    }
    
    /* Optimize Image Rendering */
    .card-img-top {
        image-rendering: -webkit-optimize-contrast;
        image-rendering: crisp-edges;
        backface-visibility: hidden;
        transform: translateZ(0);
        will-change: transform;
    }
    
    /* Card Hover Performance Optimization */
    .card {
        transform: translateZ(0);
        backface-visibility: hidden;
        will-change: transform;
    }
    
    /* Loading Spinner for Images */
    .image-loading-spinner {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 40px;
        height: 40px;
        border: 3px solid rgba(255, 255, 255, 0.1);
        border-top: 3px solid #ff6026;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        z-index: 1;
    }
    
    @keyframes spin {
        0% { transform: translate(-50%, -50%) rotate(0deg); }
        100% { transform: translate(-50%, -50%) rotate(360deg); }
    }
    
    /* Fade In Animation */
    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: scale(0.95);
        }
        to {
            opacity: 1;
            transform: scale(1);
        }
    }
    
    .fade-in {
        animation: fadeIn 0.3s ease-in-out;
    }
</style>

{% endblock %}

{% block body %}

<div class="container-fluid">

    {% for message in messages %}

    <div class="alert {{ message.tags }} alert-dismissible fade show" role="alert">
        <strong>{{ message.tag }}</strong> {{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>

    {% endfor %}

    <!-- Loading State -->
    <div id="loading-container" class="text-center py-5">
        <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
            <span class="visually-hidden">Loading...</span>
        </div>
        <h4 class="mt-3 text-muted">Loading your courses...</h4>
    </div>

    <!-- Error State -->
    <div id="error-container" class="alert alert-danger" style="display: none;" role="alert">
        <h4 class="alert-heading"><i class="fas fa-exclamation-triangle"></i> Error Loading Data</h4>
        <p id="error-message"></p>
        <hr>
        <button class="btn btn-danger" onclick="loadBatchData()">Retry</button>
    </div>

    <!-- Main Content Container -->
    <div id="main-content" style="display: none;">

        <!-- ===============================================================================================-->
        <!-- ============================================ JOVAC ARCHIVED ===================================-->
        <!-- ===============================================================================================-->

        <div class="card mb-4" id="jovac-section" style="display: none;">
        <div class="card-header" style="cursor: pointer;" data-bs-toggle="collapse" data-bs-target="#jovacArchiveSection" aria-expanded="false" aria-controls="jovacArchiveSection">
            <div class="d-flex justify-content-between align-items-center">
                <h3 class="heading">
                    <span class="fw-semibold">J O V A C üìÅ</span>
                    <span class="fs-4 text-muted"> | Archived Courses
                    </span>
                    <small class="badge bg-secondary ms-2">Archived</small>
                </h3>
                
                <i class="fas fa-chevron-down transition-icon" id="jovacToggleIcon"></i>
            </div>
        </div>
        
        <div class="collapse" id="jovacArchiveSection">
            <div class="card-body">
                <!-- =========================================== APPROVED JOVAC COURSES =========================== -->
                <div class="row row-cols-1 row-cols-md-3 g-4" id="approved-courses-container">
                    <!-- Courses will be loaded dynamically via AJAX -->
                </div>
                
                <div class="row row-cols-1 row-cols-md-3 g-4 mt-2" id="pending-courses-container">
                    <!-- Pending courses will be loaded dynamically via AJAX -->
                </div>
                
                <div class="row row-cols-1 row-cols-md-3 g-4 mt-2" id="rejected-courses-container">
                    <!-- Rejected courses will be loaded dynamically via AJAX -->
                </div>
                
                <div class="row row-cols-1 row-cols-md-3 g-4 mt-2" id="other-courses-container">
                    <!-- Other courses will be loaded dynamically via AJAX -->
                </div>
            </div>
        </div>
        </div>

        <!-- ===============================================================================================-->
        <!-- =========================================== BATCHES ===========================================-->
        <!-- ===============================================================================================-->

        <div class="card" id="my-courses-header" style="display: none;">
            <div class="card-body">
                <h3 class="heading">
                    <span class="fw-semibold">M Y &nbsp; C O U R S E S üî•</span>
                    <span class="fs-4"> | Angaar x W3Grads
                    </span>
                </h3>
            </div>
        </div>

        <!-- ======================== COURSE CODE ====================== -->

        <div class="row row-cols-1 row-cols-md-3 g-4" id="student-batches-container">
            <!-- Student batches will be loaded dynamically via AJAX -->
        </div>

        <!-- ======================== ALL BATCH DATA TABLE ====================== -->

        <div class="card" id="all-courses-header" style="display: none;">

            <div class="card-body">
                <h3 class="heading">
                    <span class="fw-semibold">A L L &nbsp; C O U R S E S üî•</span>
                    <span class="fs-4"> | Angaar x W3Grads
                    </span>
                </h3>
            </div>
        </div>

        <!-- ======================== COURSE CODE ====================== -->

        <div class="row row-cols-1 row-cols-md-3 g-4" id="pending-batches-container">
            <!-- Pending batches will be loaded dynamically via AJAX -->
        </div>
        
        <div class="row row-cols-1 row-cols-md-3 g-4 mt-2" id="rejected-batches-container">
            <!-- Rejected batches will be loaded dynamically via AJAX -->
        </div>
        
        <div class="row row-cols-1 row-cols-md-3 g-4 mt-2" id="other-batches-container">
            <!-- Other batches will be loaded dynamically via AJAX -->
        </div>
    </div>
    <!-- End of main-content -->

    <!-- Enrollment Modal -->
    <div class="modal fade" id="enrollModal" tabindex="-1" aria-labelledby="enrollModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="enrollModalLabel">Enroll in <span id="modalBatchName"></span></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form id="enrollForm" method="POST">
                    {% csrf_token %}
                    <div class="modal-body">
                        <input type="hidden" name="batch_id" id="modalBatchId">
                        <div id="extraFieldsContainer"></div>
                    </div>
                    <div class="modal-footer">
                        <button type="submit" class="btn btn-primary">Submit</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>


<script>
    document.addEventListener("DOMContentLoaded", function () {
        const enrollButtons = document.querySelectorAll(".enroll-btn");
        const modalBatchName = document.getElementById("modalBatchName");
        const modalBatchId = document.getElementById("modalBatchId");
        const extraFieldsContainer = document.getElementById("extraFieldsContainer");
        const enrollForm = document.getElementById("enrollForm");

        // Handle JOVAC archive section toggle
        const jovacToggle = document.querySelector('[data-bs-target="#jovacArchiveSection"]');
        const jovacIcon = document.getElementById('jovacToggleIcon');
        
        if (jovacToggle) {
            jovacToggle.addEventListener('click', function() {
                const isExpanded = this.getAttribute('aria-expanded') === 'true';
                jovacIcon.style.transform = isExpanded ? 'rotate(0deg)' : 'rotate(180deg)';
            });
        }

        // Comprehensive list of Indian colleges and universities
        const collegesList = [
            // IITs
            "IIT Delhi", "IIT Bombay", "IIT Madras", "IIT Kanpur", "IIT Kharagpur",
            "IIT Roorkee", "IIT Guwahati", "IIT Hyderabad", "IIT Indore", "IIT BHU Varanasi",
            "IIT Gandhinagar", "IIT Ropar", "IIT Patna", "IIT Bhubaneswar", "IIT Jodhpur",
            "IIT Mandi", "IIT Palakkad", "IIT Tirupati", "IIT Dhanbad", "IIT Jammu",
            "IIT Goa", "IIT Dharwad", "IIT Bhilai",
            
            // NITs
            "NIT Trichy", "NIT Surathkal", "NIT Warangal", "NIT Calicut", "NIT Rourkela",
            "NIT Durgapur", "NIT Jaipur", "NIT Kurukshetra", "NIT Silchar", "NIT Hamirpur",
            "NIT Jalandhar", "NIT Allahabad", "NIT Bhopal", "NIT Jamshedpur", "NIT Raipur",
            "NIT Agartala", "NIT Arunachal Pradesh", "NIT Delhi", "NIT Goa", "NIT Meghalaya",
            "NIT Manipur", "NIT Mizoram", "NIT Nagaland", "NIT Patna", "NIT Puducherry",
            "NIT Sikkim", "NIT Srinagar", "NIT Uttarakhand", "NIT Andhra Pradesh",
            
            // IIITs
            "IIIT Hyderabad", "IIIT Allahabad", "IIIT Bangalore", "IIIT Delhi",
            "IIIT Gwalior", "IIIT Jabalpur", "IIIT Kota", "IIIT Vadodara",
            "IIIT Pune", "IIIT Kancheepuram", "IIIT Lucknow", "IIIT Nagpur",
            
            // DTU/NSUT
            "Delhi Technological University (DTU)", "Netaji Subhas University of Technology (NSUT)",
            
            // Other Major Universities - Delhi NCR
            "Indraprastha Institute of Information Technology Delhi (IIIT-D)",
            "Guru Gobind Singh Indraprastha University (GGSIPU)",
            "Jamia Millia Islamia", "Jawaharlal Nehru University",
            "Ambedkar University Delhi", "Delhi University",
            "Amity University Noida", "Shiv Nadar University",
            "Bennett University Greater Noida", "Ashoka University",
            "JIIT Noida", "JIMS Noida", "GTBIT Delhi",
            "Maharaja Agrasen Institute of Technology", "NSIT Delhi",
            "Indira Gandhi Delhi Technical University for Women (IGDTUW)",
            "Bharati Vidyapeeth's College of Engineering",
            "Netaji Subhas Institute of Technology (NSIT)",
            "Anand College Delhi (ANDC)",
            "Laxmibai College Delhi",
            "KCC Institute of Technology & Management",
            "Greater Noida Institute of Technology (GNIOT)",
            "Galgotias College of Engineering and Technology",

            
            // Uttar Pradesh
            "GLA University Mathura", "GL Bajaj Institute of Technology and Management Mathura",
            "BSA College of Engineering and Technology Mathura",
            "AKGEC Ghaziabad", "Ajay Kumar Garg Engineering College",
            "IMS Engineering College Ghaziabad",
            "IET Lucknow", "KNIT Sultanpur", "MMMUT Gorakhpur",
            "BIT Mesra", "HBTU Kanpur", "Galgotias University",
            "Sharda University", "Aligarh Muslim University",
            
            // Maharashtra
            "VJTI Mumbai", "COEP Pune", "PICT Pune", "SPIT Mumbai",
            "DJ Sanghvi College of Engineering", "KJ Somaiya College of Engineering",
            "Sardar Patel Institute of Technology", "Ramrao Adik Institute of Technology",
            "MIT Pune", "VIT Pune", "IIIT Pune",
            
            // Karnataka
            "RVCE Bangalore", "BMS College of Engineering", "PES University",
            "MS Ramaiah Institute of Technology", "Dayananda Sagar College of Engineering",
            "JSS Science and Technology University", "NMIT Bangalore",
            
            // Tamil Nadu
            "Anna University", "PSG College of Technology", "Thiagarajar College of Engineering",
            "SSN College of Engineering", "SRM University", "VIT Vellore",
            "Amrita Vishwa Vidyapeetham",
            
            // Telangana
            "BITS Pilani Hyderabad Campus", "Vasavi College of Engineering",
            "CVR College of Engineering", "CBIT Hyderabad",
            "Osmania University", "JNTUH",
            
            // Rajasthan
            "BITS Pilani", "Manipal University Jaipur", "Poornima University",
            "LNM Institute of Information Technology", "MBM Engineering College Jodhpur",
            "UEM Jaipur",
            
            // Uttarakhand
            "Tula's Institute Dehradun", "Graphic Era University",
            "DIT University", "UPES Dehradun",
            
            // Gujarat
            "DAIICT Gandhinagar", "Nirma University", "LDCE Ahmedabad",
            "SVNIT Surat", "GEC Gandhinagar",
            
            // West Bengal
            "Jadavpur University", "Heritage Institute of Technology",
            "Techno India", "Kalyani Government Engineering College",
            
            // Other States
            "Thapar University Patiala", "Chitkara University",
            "LPU Jalandhar", "PEC Chandigarh",
            "Manipal Institute of Technology", "Christ University Bangalore",
            "Sikkim Manipal Institute of Technology"
        ].sort();

        enrollButtons.forEach(button => {
            button.addEventListener("click", function () {
                const batchId = this.getAttribute("data-batch-id");
                const batchName = this.getAttribute("data-batch-name");
                let requiredFields = this.getAttribute("data-required-fields");
                // convert requiredFields to JSON parsable string
                requiredFields = requiredFields.replace(/'/g, '"');

                try {
                    requiredFields = JSON.parse(requiredFields);  // Properly parse JSON
                    console.log(requiredFields);
                } catch (e) {
                    requiredFields = [];  // Fallback to empty array if invalid
                    alert("Invalid required fields data");
                }

                // Set batch name and ID
                modalBatchName.textContent = batchName;
                modalBatchId.value = batchId;

                // Generate required fields dynamically
                extraFieldsContainer.innerHTML = "";
                requiredFields.forEach(field => {
                    let label = field.replace(/_/g, " ").toUpperCase();
                    
                    // Special handling for college_name field
                    if (field.toLowerCase() === 'college_name') {
                        extraFieldsContainer.innerHTML += `
                            <div class="mb-3">
                                <label class="form-label">
                                    ${label} <span class="text-danger">*</span>
                                    <span id="results_badge_${field}" class="search-results-badge" style="display: none;">
                                        <i class="fas fa-check-circle"></i> 0 found
                                    </span>
                                </label>
                                
                                <!-- Search input with icon -->
                                <div class="input-group mb-2">
                                    <span class="input-group-text">
                                        <i class="fas fa-search search-icon"></i>
                                    </span>
                                    <input type="text" 
                                           id="college_search_${field}" 
                                           class="form-control college-search-input" 
                                           placeholder="üîç Search from ${collegesList.length}+ colleges..." 
                                           autocomplete="off">
                                </div>
                                
                                <!-- Dropdown with all colleges -->
                                <select name="${field}" id="college_select_${field}" class="form-control college-dropdown" required size="6">
                                    <option value="" disabled selected>üëá Select your college from below</option>
                                    ${collegesList.map(college => `<option value="${college}">${college}</option>`).join('')}
                                    <option value="other">‚úèÔ∏è Other (Enter Manually)</option>
                                </select>
                                <small class="text-muted d-block mt-1">
                                    <i class="fas fa-info-circle"></i> Can't find your college? Select "Other" to enter manually
                                </small>
                                
                                <!-- Custom input for manual entry -->
                                <input type="text" 
                                       name="${field}_custom" 
                                       id="college_custom_${field}" 
                                       class="form-control mt-2 college-custom-input" 
                                       placeholder="‚úèÔ∏è Enter your college name here..." 
                                       style="display: none;">
                            </div>
                        `;
                    } else {
                        // Regular text input for other fields
                        extraFieldsContainer.innerHTML += `
                            <div class="mb-3">
                                <label class="form-label">${label}</label>
                                <input type="text" placeholder="Enter your ${label} here..." name="${field}" class="form-control" required>
                            </div>
                        `;
                    }
                });

                // Add event listeners for college search functionality
                const collegeSearchInputs = document.querySelectorAll('[id^="college_search_"]');
                collegeSearchInputs.forEach(searchInput => {
                    const fieldName = searchInput.id.replace('college_search_', '');
                    const dropdown = document.getElementById(`college_select_${fieldName}`);
                    const resultsBadge = document.getElementById(`results_badge_${fieldName}`);
                    
                    searchInput.addEventListener('input', function() {
                        const searchTerm = this.value.toLowerCase().trim();
                        const options = dropdown.querySelectorAll('option');
                        let visibleCount = 0;
                        
                        options.forEach(option => {
                            if (option.value === '' || option.value === 'other') {
                                // Always show the placeholder and "Other" option
                                option.style.display = '';
                                return;
                            }
                            
                            const collegeText = option.textContent.toLowerCase();
                            if (collegeText.includes(searchTerm)) {
                                option.style.display = '';
                                visibleCount++;
                            } else {
                                option.style.display = 'none';
                            }
                        });
                        
                        // Update results badge
                        if (searchTerm.length > 0) {
                            resultsBadge.style.display = 'inline-block';
                            resultsBadge.innerHTML = `<i class="fas fa-check-circle"></i> ${visibleCount} found`;
                        } else {
                            resultsBadge.style.display = 'none';
                        }
                        
                        // Auto-select if only one college matches
                        if (visibleCount === 1 && searchTerm.length > 2) {
                            const visibleOption = Array.from(options).find(opt => 
                                opt.style.display !== 'none' && opt.value !== '' && opt.value !== 'other'
                            );
                            if (visibleOption) {
                                dropdown.value = visibleOption.value;
                                // Add visual feedback
                                dropdown.style.borderColor = '#28a745';
                                setTimeout(() => {
                                    dropdown.style.borderColor = '';
                                }, 1000);
                            }
                        }
                    });
                    
                    // Clear search when dropdown is selected
                    dropdown.addEventListener('change', function() {
                        searchInput.value = '';
                        resultsBadge.style.display = 'none';
                        // Reset all options visibility
                        const options = dropdown.querySelectorAll('option');
                        options.forEach(option => {
                            option.style.display = '';
                        });
                    });
                    
                    // Keyboard navigation: Enter key to focus dropdown
                    searchInput.addEventListener('keydown', function(e) {
                        if (e.key === 'Enter') {
                            e.preventDefault();
                            const visibleOptions = Array.from(dropdown.querySelectorAll('option')).filter(opt => 
                                opt.style.display !== 'none' && opt.value !== '' && opt.value !== 'other'
                            );
                            
                            if (visibleOptions.length === 1) {
                                // Auto-select the only visible option
                                dropdown.value = visibleOptions[0].value;
                                dropdown.dispatchEvent(new Event('change'));
                            } else if (visibleOptions.length > 0) {
                                // Focus the dropdown for manual selection
                                dropdown.focus();
                            }
                        } else if (e.key === 'Escape') {
                            // Clear search on Escape
                            this.value = '';
                            this.dispatchEvent(new Event('input'));
                        }
                    });
                });
                
                // Add event listeners for college dropdown changes
                const collegeDropdowns = document.querySelectorAll('.college-dropdown');
                collegeDropdowns.forEach(dropdown => {
                    dropdown.addEventListener('change', function() {
                        const fieldName = this.name;
                        const customInput = document.getElementById(`college_custom_${fieldName}`);
                        
                        if (this.value === 'other') {
                            // Show custom input and make it required
                            customInput.style.display = 'block';
                            customInput.required = true;
                            this.required = false;
                            // Clear the dropdown selection to avoid confusion
                            this.value = '';
                        } else {
                            // Hide custom input and make dropdown required
                            customInput.style.display = 'none';
                            customInput.required = false;
                            customInput.value = '';
                            this.required = true;
                        }
                    });
                });

                // Update form action dynamically
                enrollForm.action = `/dashboard/enroll_course/${batchId}/`;
            });
        });

        // Form validation on submit
        enrollForm.addEventListener('submit', function(e) {
            const collegeDropdowns = document.querySelectorAll('.college-dropdown');
            let isValid = true;
            let errorMessage = '';

            collegeDropdowns.forEach(dropdown => {
                const fieldName = dropdown.name;
                const customInput = document.getElementById(`college_custom_${fieldName}`);
                
                // Check if both dropdown and custom input are empty
                if ((!dropdown.value || dropdown.value === '') && (!customInput.value || customInput.value.trim() === '')) {
                    isValid = false;
                    errorMessage = 'Please select a college from the dropdown or enter it manually.';
                    dropdown.classList.add('is-invalid');
                    if (customInput.style.display !== 'none') {
                        customInput.classList.add('is-invalid');
                    }
                } else {
                    dropdown.classList.remove('is-invalid');
                    customInput.classList.remove('is-invalid');
                }
            });

            if (!isValid) {
                e.preventDefault();
                alert(errorMessage);
                return false;
            }
        });
    });

    // ========================================
    // AJAX API CALL TO LOAD BATCH DATA
    // ========================================
    
    function loadBatchData() {
        // Show loading, hide error and main content
        document.getElementById('loading-container').style.display = 'block';
        document.getElementById('error-container').style.display = 'none';
        document.getElementById('main-content').style.display = 'none';

        fetch('/dashboard/api/fetch_my_batch_data/', {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            },
            credentials: 'same-origin'
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            if (!data.success) {
                throw new Error(data.error || 'Unknown error occurred');
            }
            
            // Hide loading and show main content
            document.getElementById('loading-container').style.display = 'none';
            document.getElementById('main-content').style.display = 'block';
            
            // Render the data
            renderBatches(data.batches);
            renderCourses(data.courses);
        })
        .catch(error => {
            console.error('Error loading batch data:', error);
            
            // Show error state
            document.getElementById('loading-container').style.display = 'none';
            document.getElementById('error-container').style.display = 'block';
            document.getElementById('error-message').textContent = error.message || 'Failed to load course data. Please try again.';
        });
    }

    // ========================================
    // LAZY LOADING HELPER FUNCTION
    // ========================================
    
    function initializeLazyLoading() {
        const lazyImages = document.querySelectorAll('.lazy-image');
        
        if ('IntersectionObserver' in window) {
            // Use Intersection Observer for better performance
            const imageObserver = new IntersectionObserver((entries, observer) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        const img = entry.target;
                        const src = img.getAttribute('data-src');
                        
                        if (src) {
                            // Create new image to preload
                            const tempImg = new Image();
                            
                            tempImg.onload = function() {
                                img.src = src;
                                img.classList.add('loaded');
                                img.classList.add('fade-in');
                                
                                // Remove skeleton loader
                                const skeleton = img.previousElementSibling;
                                if (skeleton && skeleton.classList.contains('image-skeleton')) {
                                    skeleton.style.display = 'none';
                                }
                            };
                            
                            tempImg.onerror = function() {
                                img.classList.add('error');
                                img.src = 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" width="200" height="200"%3E%3Crect fill="%23333" width="200" height="200"/%3E%3Ctext fill="%23666" font-size="18" x="50%25" y="50%25" text-anchor="middle" dy=".3em"%3EImage Error%3C/text%3E%3C/svg%3E';
                                
                                // Remove skeleton loader
                                const skeleton = img.previousElementSibling;
                                if (skeleton && skeleton.classList.contains('image-skeleton')) {
                                    skeleton.style.display = 'none';
                                }
                            };
                            
                            tempImg.src = src;
                        }
                        
                        observer.unobserve(img);
                    }
                });
            }, {
                rootMargin: '50px', // Start loading 50px before entering viewport
                threshold: 0.01
            });
            
            lazyImages.forEach(img => imageObserver.observe(img));
        } else {
            // Fallback for browsers without Intersection Observer
            lazyImages.forEach(img => {
                const src = img.getAttribute('data-src');
                if (src) {
                    img.src = src;
                    img.classList.add('loaded');
                }
            });
        }
    }

    // ========================================
    // RENDER BATCHES FUNCTION
    // ========================================
    
    function renderBatches(batches) {
        const { student_batches, pending_batches, rejected_batches, other_batches } = batches;
        
        // Render student batches
        const studentBatchesContainer = document.getElementById('student-batches-container');
        studentBatchesContainer.innerHTML = '';
        
        if (student_batches && student_batches.length > 0) {
            document.getElementById('my-courses-header').style.display = 'block';
            student_batches.forEach(batch => {
                studentBatchesContainer.innerHTML += createStudentBatchCard(batch);
            });
        }
        
        // Show all courses header if there are any non-student batches
        if ((pending_batches && pending_batches.length > 0) || 
            (rejected_batches && rejected_batches.length > 0) || 
            (other_batches && other_batches.length > 0)) {
            document.getElementById('all-courses-header').style.display = 'block';
        }
        
        // Render pending batches
        const pendingBatchesContainer = document.getElementById('pending-batches-container');
        pendingBatchesContainer.innerHTML = '';
        if (pending_batches && pending_batches.length > 0) {
            pending_batches.forEach(batch => {
                pendingBatchesContainer.innerHTML += createPendingBatchCard(batch);
            });
        }
        
        // Render rejected batches
        const rejectedBatchesContainer = document.getElementById('rejected-batches-container');
        rejectedBatchesContainer.innerHTML = '';
        if (rejected_batches && rejected_batches.length > 0) {
            rejected_batches.forEach(batch => {
                rejectedBatchesContainer.innerHTML += createRejectedBatchCard(batch);
            });
        }
        
        // Render other batches
        const otherBatchesContainer = document.getElementById('other-batches-container');
        otherBatchesContainer.innerHTML = '';
        if (other_batches && other_batches.length > 0) {
            other_batches.forEach(batch => {
                otherBatchesContainer.innerHTML += createOtherBatchCard(batch);
            });
            
            // Re-attach enroll button event listeners
            attachEnrollButtonListeners();
        }
        
        // Initialize lazy loading for batch images
        setTimeout(() => initializeLazyLoading(), 100);
    }

    // ========================================
    // RENDER COURSES FUNCTION
    // ========================================
    
    function renderCourses(courses) {
        const { approved_courses, pending_courses, rejected_courses, other_courses } = courses;
        
        // Show JOVAC section if there are any courses
        if ((approved_courses && approved_courses.length > 0) || 
            (pending_courses && pending_courses.length > 0) || 
            (rejected_courses && rejected_courses.length > 0) || 
            (other_courses && other_courses.length > 0)) {
            document.getElementById('jovac-section').style.display = 'block';
        }
        
        // Render approved courses
        const approvedCoursesContainer = document.getElementById('approved-courses-container');
        approvedCoursesContainer.innerHTML = '';
        if (approved_courses && approved_courses.length > 0) {
            approved_courses.forEach(course => {
                approvedCoursesContainer.innerHTML += createApprovedCourseCard(course);
            });
        }
        
        // Render pending courses
        const pendingCoursesContainer = document.getElementById('pending-courses-container');
        pendingCoursesContainer.innerHTML = '';
        if (pending_courses && pending_courses.length > 0) {
            pending_courses.forEach(course => {
                pendingCoursesContainer.innerHTML += createPendingCourseCard(course);
            });
        }
        
        // Render rejected courses
        const rejectedCoursesContainer = document.getElementById('rejected-courses-container');
        rejectedCoursesContainer.innerHTML = '';
        if (rejected_courses && rejected_courses.length > 0) {
            rejected_courses.forEach(course => {
                rejectedCoursesContainer.innerHTML += createRejectedCourseCard(course);
            });
        }
        
        // Render other courses
        const otherCoursesContainer = document.getElementById('other-courses-container');
        otherCoursesContainer.innerHTML = '';
        if (other_courses && other_courses.length > 0) {
            other_courses.forEach(course => {
                otherCoursesContainer.innerHTML += createOtherCourseCard(course);
            });
        }
        
        // Initialize lazy loading for course images
        setTimeout(() => initializeLazyLoading(), 100);
    }

    // ========================================
    // BATCH CARD TEMPLATES
    // ========================================
    
    function createStudentBatchCard(batch) {
        return `
            <div class="col-md-3">
                <h5 class="card-title fw-semibold mb-0"></h5>
                <div class="card">
                    <a href="/dashboard/${batch.slug}/">
                        <div class="lazy-image-container">
                            <div class="image-skeleton"></div>
                            <img data-src="${batch.thumbnail}" class="card-img-top lazy-image" alt="${batch.name}" loading="lazy" />
                        </div>
                        <div class="card-body">
                            <h5 class="card-title">${batch.name}üî•</h5>
                            <a href="/dashboard/${batch.slug}/" class="btn btn-outline-secondary w-100">View More</a>
                        </div>
                    </a>
                </div>
            </div>
        `;
    }
    
    function createPendingBatchCard(batch) {
        return `
            <div class="col-md-3">
                <div class="card">
                    <div class="lazy-image-container">
                        <div class="image-skeleton"></div>
                        <img data-src="${batch.thumbnail}" class="card-img-top lazy-image" alt="${batch.name}" loading="lazy" />
                    </div>
                    <div class="card-body">
                        <h5 class="card-title">${batch.name}üî•</h5>
                        <button class="btn btn-outline-warning w-100" disabled>Requested</button>
                    </div>
                </div>
            </div>
        `;
    }
    
    function createRejectedBatchCard(batch) {
        return `
            <div class="col-md-3">
                <div class="card">
                    <div class="lazy-image-container">
                        <div class="image-skeleton"></div>
                        <img data-src="${batch.thumbnail}" class="card-img-top lazy-image" alt="${batch.name}" loading="lazy" />
                    </div>
                    <div class="card-body">
                        <h5 class="card-title">${batch.name}üî•</h5>
                        <button class="btn btn-danger w-100" disabled>Rejected</button>
                    </div>
                </div>
            </div>
        `;
    }
    
    function createOtherBatchCard(batch) {
        const hasRequiredFields = batch.required_fields && batch.required_fields.length > 0;
        const enrollButton = hasRequiredFields 
            ? `<button class="btn btn-success w-100 enroll-btn" data-bs-toggle="modal"
                    data-bs-target="#enrollModal" data-batch-id="${batch.id}"
                    data-batch-name="${batch.name}" data-required-fields='${JSON.stringify(batch.required_fields)}'>
                    Enroll Now
               </button>
               <p class="text-success mt-2">Require Extra Info!</p>`
            : `<a href="/dashboard/enroll_course/${batch.id}/" class="btn btn-success w-100">Enroll Now</a>`;
        
        return `
            <div class="col-md-3">
                <div class="card">
                    <a href="#">
                        <div class="lazy-image-container">
                            <div class="image-skeleton"></div>
                            <img data-src="${batch.thumbnail}" class="card-img-top lazy-image" alt="${batch.name}" loading="lazy" />
                        </div>
                        <div class="card-body">
                            <h5 class="card-title">${batch.name}üî•</h5>
                            ${enrollButton}
                        </div>
                    </a>
                </div>
            </div>
        `;
    }

    // ========================================
    // COURSE CARD TEMPLATES
    // ========================================
    
    function createApprovedCourseCard(course) {
        return `
            <div class="col-md-3">
                <h5 class="card-title fw-semibold mb-0"></h5>
                <div class="card position-relative">
                    <div class="position-absolute top-0 end-0 m-2">
                        <span class="badge bg-dark">Archived</span>
                    </div>
                    <a href="/dashboard/jovac/${course.slug}/" class="text-decoration-none">
                        <div class="lazy-image-container">
                            <div class="image-skeleton"></div>
                            <img data-src="${course.thumbnail}" class="card-img-top lazy-image" alt="${course.name}" style="opacity: 0.8;" loading="lazy" />
                        </div>
                        <div class="card-body">
                            <h5 class="">${course.name}üìÅ</h5>
                            By: <p class="card-text">${course.instructor_names}</p>
                            <a href="/dashboard/jovac/${course.slug}/" class="btn btn-outline-secondary w-100">View Archive</a>
                        </div>
                    </a>
                </div>
            </div>
        `;
    }
    
    function createPendingCourseCard(course) {
        return `
            <div class="col-md-3">
                <div class="card position-relative">
                    <div class="position-absolute top-0 end-0 m-2">
                        <span class="badge bg-secondary">Archived</span>
                    </div>
                    <div class="lazy-image-container">
                        <div class="image-skeleton"></div>
                        <img data-src="${course.thumbnail}" class="card-img-top lazy-image" alt="${course.name}" style="opacity: 0.8;" loading="lazy" />
                    </div>
                    <div class="card-body">
                        <h5 class="card-title text-muted">${course.name}üìÅ</h5>
                        By: <p class="card-text text-muted fs-6 mb-2">${course.instructor_names}</p>
                        <button class="btn btn-outline-secondary w-100" disabled>Was Requested</button>
                    </div>
                </div>
            </div>
        `;
    }
    
    function createRejectedCourseCard(course) {
        return `
            <div class="col-md-3">
                <div class="card position-relative">
                    <div class="position-absolute top-0 end-0 m-2">
                        <span class="badge bg-secondary">Archived</span>
                    </div>
                    <div class="lazy-image-container">
                        <div class="image-skeleton"></div>
                        <img data-src="${course.thumbnail}" class="card-img-top lazy-image" alt="${course.name}" style="opacity: 0.8;" loading="lazy" />
                    </div>
                    <div class="card-body">
                        <h5 class="card-title text-muted">${course.name}üìÅ</h5>
                        <button class="btn btn-outline-secondary w-100" disabled>Was Rejected</button>
                    </div>
                </div>
            </div>
        `;
    }
    
    function createOtherCourseCard(course) {
        return `
            <div class="col-md-3">
                <div class="card position-relative">
                    <div class="position-absolute top-0 end-0 m-2">
                        <span class="badge bg-secondary">Archived</span>
                    </div>
                    <a href="#" class="text-decoration-none">
                        <div class="lazy-image-container">
                            <div class="image-skeleton"></div>
                            <img data-src="${course.thumbnail}" class="card-img-top lazy-image" alt="${course.name}" style="opacity: 0.8;" loading="lazy" />
                        </div>
                        <div class="card-body">
                            <h5 class="card-title text-muted">${course.name}üìÅ</h5>
                            By: <p class="card-text text-muted fs-6 mb-2">${course.instructor_names}</p>
                            <button class="btn btn-outline-secondary w-100" disabled>No Longer Available</button>
                        </div>
                    </a>
                </div>
            </div>
        `;
    }

    // ========================================
    // RE-ATTACH EVENT LISTENERS
    // ========================================
    
    function attachEnrollButtonListeners() {
        const enrollButtons = document.querySelectorAll(".enroll-btn");
        
        enrollButtons.forEach(button => {
            button.addEventListener("click", function () {
                const batchId = this.getAttribute("data-batch-id");
                const batchName = this.getAttribute("data-batch-name");
                let requiredFields = this.getAttribute("data-required-fields");

                try {
                    requiredFields = JSON.parse(requiredFields);
                    console.log(requiredFields);
                } catch (e) {
                    requiredFields = [];
                    alert("Invalid required fields data");
                }

                // Set batch name and ID
                modalBatchName.textContent = batchName;
                modalBatchId.value = batchId;

                // Generate required fields dynamically
                extraFieldsContainer.innerHTML = "";
                requiredFields.forEach(field => {
                    let label = field.replace(/_/g, " ").toUpperCase();
                    
                    // Special handling for college_name field
                    if (field.toLowerCase() === 'college_name') {
                        extraFieldsContainer.innerHTML += `
                            <div class="mb-3">
                                <label class="form-label">
                                    ${label} <span class="text-danger">*</span>
                                    <span id="results_badge_${field}" class="search-results-badge" style="display: none;">
                                        <i class="fas fa-check-circle"></i> 0 found
                                    </span>
                                </label>
                                
                                <!-- Search input with icon -->
                                <div class="input-group mb-2">
                                    <span class="input-group-text">
                                        <i class="fas fa-search search-icon"></i>
                                    </span>
                                    <input type="text" 
                                           id="college_search_${field}" 
                                           class="form-control college-search-input" 
                                           placeholder="üîç Search from ${collegesList.length}+ colleges..." 
                                           autocomplete="off">
                                </div>
                                
                                <!-- Dropdown with all colleges -->
                                <select name="${field}" id="college_select_${field}" class="form-control college-dropdown" required size="6">
                                    <option value="" disabled selected>üëá Select your college from below</option>
                                    ${collegesList.map(college => `<option value="${college}">${college}</option>`).join('')}
                                    <option value="other">‚úèÔ∏è Other (Enter Manually)</option>
                                </select>
                                <small class="text-muted d-block mt-1">
                                    <i class="fas fa-info-circle"></i> Can't find your college? Select "Other" to enter manually
                                </small>
                                
                                <!-- Custom input for manual entry -->
                                <input type="text" 
                                       name="${field}_custom" 
                                       id="college_custom_${field}" 
                                       class="form-control mt-2 college-custom-input" 
                                       placeholder="‚úèÔ∏è Enter your college name here..." 
                                       style="display: none;">
                            </div>
                        `;
                    } else {
                        // Regular text input for other fields
                        extraFieldsContainer.innerHTML += `
                            <div class="mb-3">
                                <label class="form-label">${label}</label>
                                <input type="text" placeholder="Enter your ${label} here..." name="${field}" class="form-control" required>
                            </div>
                        `;
                    }
                });

                // Re-attach event listeners for college search and dropdown
                attachCollegeFieldListeners();

                // Update form action dynamically
                enrollForm.action = `/dashboard/enroll_course/${batchId}/`;
            });
        });
    }

    // Helper function to attach college field listeners
    function attachCollegeFieldListeners() {
        const collegeSearchInputs = document.querySelectorAll('[id^="college_search_"]');
        collegeSearchInputs.forEach(searchInput => {
            const fieldName = searchInput.id.replace('college_search_', '');
            const dropdown = document.getElementById(`college_select_${fieldName}`);
            const resultsBadge = document.getElementById(`results_badge_${fieldName}`);
            
            searchInput.addEventListener('input', function() {
                const searchTerm = this.value.toLowerCase().trim();
                const options = dropdown.querySelectorAll('option');
                let visibleCount = 0;
                
                options.forEach(option => {
                    if (option.value === '' || option.value === 'other') {
                        option.style.display = '';
                        return;
                    }
                    
                    const collegeText = option.textContent.toLowerCase();
                    if (collegeText.includes(searchTerm)) {
                        option.style.display = '';
                        visibleCount++;
                    } else {
                        option.style.display = 'none';
                    }
                });
                
                if (searchTerm.length > 0) {
                    resultsBadge.style.display = 'inline-block';
                    resultsBadge.innerHTML = `<i class="fas fa-check-circle"></i> ${visibleCount} found`;
                } else {
                    resultsBadge.style.display = 'none';
                }
                
                if (visibleCount === 1 && searchTerm.length > 2) {
                    const visibleOption = Array.from(options).find(opt => 
                        opt.style.display !== 'none' && opt.value !== '' && opt.value !== 'other'
                    );
                    if (visibleOption) {
                        dropdown.value = visibleOption.value;
                        dropdown.style.borderColor = '#28a745';
                        setTimeout(() => {
                            dropdown.style.borderColor = '';
                        }, 1000);
                    }
                }
            });
            
            dropdown.addEventListener('change', function() {
                searchInput.value = '';
                resultsBadge.style.display = 'none';
                const options = dropdown.querySelectorAll('option');
                options.forEach(option => {
                    option.style.display = '';
                });
                
                const customInput = document.getElementById(`college_custom_${fieldName}`);
                if (this.value === 'other') {
                    customInput.style.display = 'block';
                    customInput.required = true;
                    this.required = false;
                    this.value = '';
                } else {
                    customInput.style.display = 'none';
                    customInput.required = false;
                    customInput.value = '';
                    this.required = true;
                }
            });
            
            searchInput.addEventListener('keydown', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    const visibleOptions = Array.from(dropdown.querySelectorAll('option')).filter(opt => 
                        opt.style.display !== 'none' && opt.value !== '' && opt.value !== 'other'
                    );
                    
                    if (visibleOptions.length === 1) {
                        dropdown.value = visibleOptions[0].value;
                        dropdown.dispatchEvent(new Event('change'));
                    } else if (visibleOptions.length > 0) {
                        dropdown.focus();
                    }
                } else if (e.key === 'Escape') {
                    this.value = '';
                    this.dispatchEvent(new Event('input'));
                }
            });
        });
    }

    // Load data on page load
    loadBatchData();

</script>

{% endblock %}