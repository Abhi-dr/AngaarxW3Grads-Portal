{% extends 'student/base.html' %}

{% load custom_filters %}

{% block my_batches_active %}
active
{% endblock %}

{% block title %}
Dashboard | My Courses
{% endblock %}

{% block extra_css %}

<style>
    .transition-icon {
        transition: transform 0.3s ease;
    }
    
    .card-header[aria-expanded="true"] .transition-icon {
        transform: rotate(180deg);
    }
    
    .collapse {
        transition: height 0.35s ease;
    }
</style>

{% endblock %}

{% block body %}

<div class="container-fluid">

    {% for message in messages %}

    <div class="alert {{ message.tags }} alert-dismissible fade show" role="alert">
        <strong>{{ message.tag }}</strong> {{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>

    {% endfor %}

    <!-- ===============================================================================================-->
    <!-- ============================================ JOVAC ARCHIVED ===================================-->
    <!-- ===============================================================================================-->

    <div class="card mb-4">
        <div class="card-header" style="cursor: pointer;" data-bs-toggle="collapse" data-bs-target="#jovacArchiveSection" aria-expanded="false" aria-controls="jovacArchiveSection">
            <div class="d-flex justify-content-between align-items-center">
                <h3 class="heading">
                    <span class="fw-semibold">J O V A C üìÅ</span>
                    <span class="fs-4 text-muted"> | Archived Courses
                    </span>
                    <small class="badge bg-secondary ms-2">Archived</small>
                </h3>
                
                <i class="fas fa-chevron-down transition-icon" id="jovacToggleIcon"></i>
            </div>
        </div>
        
        <div class="collapse" id="jovacArchiveSection">
            <div class="card-body">
                <!-- =========================================== APPROVED JOVAC COURSES =========================== -->
                <div class="row row-cols-1 row-cols-md-3 g-4">
                    {% for course in approved_courses %}
                    <div class="col-md-3">
                        <h5 class="card-title fw-semibold mb-0"></h5>
                        <div class="card position-relative">
                            <!-- Archived overlay -->
                            <div class="position-absolute top-0 end-0 m-2">
                                <span class="badge bg-secondary">Archived</span>
                            </div>
                            <a href="{% url 'student_jovac' course.slug %}" class="text-decoration-none">
                                <img src="{{ course.thumbnail.url }}" class="card-img-top" alt="JOVAC Thumbnail" style="opacity: 0.8;" />
                                <div class="card-body">
                                    <h5 class="card-title text-muted">
                                        {{ course.name }}üìÅ
                                    </h5>
                                    By: <p class="card-text text-muted fs-6 mb-2">
                                         {{ course.get_instructor_names }}
                                    </p>
          
                                    <a href="{% url 'student_jovac' course.slug %}" class="btn btn-outline-secondary w-100">View Archive</a>
                                </div>
                            </a>
                        </div>
                    </div>
                    {% endfor %}

                    <!-- ====================================== PENDING JOVAC ======================================== -->
                    {% for course in pending_courses %}
                    <div class="col-md-3">
                        <div class="card position-relative">
                            <div class="position-absolute top-0 end-0 m-2">
                                <span class="badge bg-secondary">Archived</span>
                            </div>
                            <img src="{{ course.thumbnail.url }}" class="card-img-top" alt="course Thumbnail" style="opacity: 0.8;" />
                            <div class="card-body">
                                <h5 class="card-title text-muted">{{ course.name }}üìÅ</h5>
                                By: <p class="card-text text-muted fs-6 mb-2">
                                         {{ course.get_instructor_names }}
                                    </p>
                                <button class="btn btn-outline-secondary w-100" disabled>Was Requested</button>
                            </div>
                        </div>
                    </div>
                    {% endfor %}

                    <!-- ====================================== REJECTED JOVAC ======================================== -->
                    {% for course in rejected_courses %}
                    <div class="col-md-3">
                        <div class="card position-relative">
                            <div class="position-absolute top-0 end-0 m-2">
                                <span class="badge bg-secondary">Archived</span>
                            </div>
                            <img src="{{ course.thumbnail.url }}" class="card-img-top" alt="course Thumbnail" style="opacity: 0.8;" />
                            <div class="card-body">
                                <h5 class="card-title text-muted">{{ course.name }}üìÅ</h5>
                                <button class="btn btn-outline-secondary w-100" disabled>Was Rejected</button>
                            </div>
                        </div>
                    </div>
                    {% endfor %}

                    <!-- ====================================== ALL OTHER JOVAC ======================================== -->
                    {% for course in other_courses %}
                    <div class="col-md-3">
                        <div class="card position-relative">
                            <div class="position-absolute top-0 end-0 m-2">
                                <span class="badge bg-secondary">Archived</span>
                            </div>
                            <a href="#" class="text-decoration-none">
                                <img src="{{ course.thumbnail.url }}" class="card-img-top" alt="course Thumbnail" style="opacity: 0.8;" />
                                <div class="card-body">
                                    <h5 class="card-title text-muted">{{ course.name }}üìÅ</h5>
                                     By: <p class="card-text text-muted fs-6 mb-2">
                                         {{ course.get_instructor_names }}
                                    </p>
                                    <button class="btn btn-outline-secondary w-100" disabled>No Longer Available</button>
                                </div>
                            </a>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>

    <!-- ===============================================================================================-->
    <!-- =========================================== BATCHES ===========================================-->
    <!-- ===============================================================================================-->

    <div class="card">
        {% if student_batches %}
        <div class="card-body">
            <h3 class="heading">
                <span class="fw-semibold">M Y &nbsp; C O U R S E S üî•</span>
                <span class="fs-4"> | Angaar x W3Grads
                </span>
            </h3>
        </div>
        {% endif %}
    </div>

    <!-- ======================== COURSE CODE ====================== -->

    <div class="row row-cols-1 row-cols-md-3 g-4">

        {% for batch in student_batches %}

        <div class="col-md-3">
            <h5 class="card-title fw-semibold mb-0"></h5>
            <div class="card">
                <a href="{% url 'batch' batch.slug %}">
                    <img src="{{ batch.thumbnail.url }}" class="card-img-top" alt="Sheet Thumbnail" />
                    <div class="card-body">
                        <h5 class="card-title">
                            {{ batch.name }}üî•
                        </h5>
                        <!-- <p class="card-text mb-2">
                            Total Sawal : {{ sheet.get_total_questions }}
                        </p> -->
                        <!-- <p class="card-text text-black mb-1">
                            Total Registrations: {{ company.job_set.all }}
                        </p> -->
                        <a href="{% url 'batch' batch.slug %}" class="btn btn-outline-secondary w-100">View More</a>
                    </div>
                </a>
            </div>
        </div>

        {% endfor %}

    </div>

    <!-- ======================== ALL BATCH DATA TABLE ====================== -->

    <div class="card">

        {% if pending_batches or other_batches or rejected_batches %}

        <div class="card-body">
            <h3 class="heading">
                <span class="fw-semibold">A L L &nbsp; C O U R S E S üî•</span>
                <span class="fs-4"> | Angaar x W3Grads
                </span>
            </h3>
        </div>

        {% endif %}
    </div>

    <!-- ======================== COURSE CODE ====================== -->

    <div class="row row-cols-1 row-cols-md-3 g-4">

        {% for batch in pending_batches %}

        <div class="col-md-3">
            <div class="card">
                <img src="{{ batch.thumbnail.url }}" class="card-img-top" alt="Batch Thumbnail" />
                <div class="card-body">
                    <h5 class="card-title">{{ batch.name }}üî•</h5>
                    <button class="btn btn-outline-warning w-100" disabled>Requested</button>
                </div>
            </div>
        </div>

        {% endfor %}

        <!-- ====================== REJECTED BATCHES =================== -->

        {% for batch in rejected_batches %}

        <div class="col-md-3">
            <div class="card">
                <img src="{{ batch.thumbnail.url }}" class="card-img-top" alt="Batch Thumbnail" />
                <div class="card-body">
                    <h5 class="card-title">{{ batch.name }}üî•</h5>
                    <button class="btn btn-danger w-100" disabled>Rejected</button>
                </div>
            </div>
        </div>

        {% endfor %}

        <!-- ====================== ALL OTHER BATCHES ================ -->

        {% for batch in other_batches %}
        <div class="col-md-3">
            <div class="card">
                <a href="#">
                    <img src="{{ batch.thumbnail.url }}" class="card-img-top" alt="Batch Thumbnail" />
                    <div class="card-body">
                        <h5 class="card-title">{{ batch.name }}üî•</h5>

                        {% if batch.required_fields %}
                        <!-- If extra fields exist, open modal -->
                        <button class="btn btn-success w-100 enroll-btn" data-bs-toggle="modal"
                            data-bs-target="#enrollModal" data-batch-id="{{ batch.id }}"
                            data-batch-name="{{ batch.name }}" data-required-fields="{{ batch.required_fields|safe }}">
                            Enroll Now
                        </button>

                        <p class="text-success mt-2">Require Extra Info!</p>

                        {% else %}
                        <!-- Direct enrollment if no extra fields -->
                        <a href="{% url 'enroll_batch' batch.id %}" class="btn btn-success w-100">Enroll Now</a>
                        {% endif %}

                    </div>
                </a>
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- Enrollment Modal -->
    <div class="modal fade" id="enrollModal" tabindex="-1" aria-labelledby="enrollModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="enrollModalLabel">Enroll in <span id="modalBatchName"></span></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form id="enrollForm" method="POST">
                    {% csrf_token %}
                    <div class="modal-body">
                        <input type="hidden" name="batch_id" id="modalBatchId">
                        <div id="extraFieldsContainer"></div>
                    </div>
                    <div class="modal-footer">
                        <button type="submit" class="btn btn-primary">Submit</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>


<script>
    document.addEventListener("DOMContentLoaded", function () {
        const enrollButtons = document.querySelectorAll(".enroll-btn");
        const modalBatchName = document.getElementById("modalBatchName");
        const modalBatchId = document.getElementById("modalBatchId");
        const extraFieldsContainer = document.getElementById("extraFieldsContainer");
        const enrollForm = document.getElementById("enrollForm");

        // Handle JOVAC archive section toggle
        const jovacToggle = document.querySelector('[data-bs-target="#jovacArchiveSection"]');
        const jovacIcon = document.getElementById('jovacToggleIcon');
        
        if (jovacToggle) {
            jovacToggle.addEventListener('click', function() {
                const isExpanded = this.getAttribute('aria-expanded') === 'true';
                jovacIcon.style.transform = isExpanded ? 'rotate(0deg)' : 'rotate(180deg)';
            });
        }

        enrollButtons.forEach(button => {
            button.addEventListener("click", function () {
                const batchId = this.getAttribute("data-batch-id");
                const batchName = this.getAttribute("data-batch-name");
                let requiredFields = this.getAttribute("data-required-fields");
                // convert requiredFields to JSON parsable string
                requiredFields = requiredFields.replace(/'/g, '"');

                try {
                    requiredFields = JSON.parse(requiredFields);  // Properly parse JSON
                    console.log(requiredFields);
                } catch (e) {
                    requiredFields = [];  // Fallback to empty array if invalid
                    alert("Invalid required fields data");
                }

                // Set batch name and ID
                modalBatchName.textContent = batchName;
                modalBatchId.value = batchId;

                // Generate required fields dynamically
                extraFieldsContainer.innerHTML = "";
                requiredFields.forEach(field => {
                    let label = field.replace("_", " ").toUpperCase();
                    extraFieldsContainer.innerHTML += `
                        <div class="mb-3">
                            <label class="form-label">${label}</label>
                            <input type="text" placeholder="Enter your ${label} here..." name="${field}" class="form-control" required>
                        </div>
                    `;
                });

                // Update form action dynamically
                enrollForm.action = `/dashboard/enroll_course/${batchId}/`;
            });
        });
    });

</script>

{% endblock %}