{% extends 'student/base.html' %}

{% load custom_filters %}

{% block my_batches_active %}
active
{% endblock %}

{% block title %}
Dashboard | My Courses
{% endblock %}

{% block extra_css %}

<style>
    .transition-icon {
        transition: transform 0.3s ease;
    }
    
    .card-header[aria-expanded="true"] .transition-icon {
        transform: rotate(180deg);
    }
    
    .collapse {
        transition: height 0.35s ease;
    }
    
    /* College Dropdown Styling - Dark Mode Compatible */
    .college-dropdown {
        padding: 0.4rem 0.5rem;
        border: 1.5px solid rgba(255, 255, 255, 0.2);
        border-radius: 0.5rem;
        font-size: 0.9rem;
        transition: all 0.3s ease;
        max-height: 200px;
        overflow-y: auto;
        background-color: rgba(255, 255, 255, 0.05);
        color: inherit;
        scrollbar-width: thin;
        scrollbar-color: rgba(255, 255, 255, 0.3) transparent;
    }
    
    .college-dropdown::-webkit-scrollbar {
        width: 6px;
    }
    
    .college-dropdown::-webkit-scrollbar-track {
        background: transparent;
    }
    
    .college-dropdown::-webkit-scrollbar-thumb {
        background-color: rgba(255, 255, 255, 0.3);
        border-radius: 10px;
    }
    
    .college-dropdown:focus {
        border-color: #0d6efd;
        box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
        outline: none;
        background-color: rgba(255, 255, 255, 0.08);
    }
    
    .college-dropdown option {
        padding: 0.6rem;
        cursor: pointer;
        background-color: var(--bs-body-bg, #212529);
        
    }

    [data-bs-theme="dark"] select>option {
    color: #ffffff;
    }
    
    .college-dropdown option:hover,
    .college-dropdown option:checked {
        background-color: rgba(13, 110, 253, 0.2);
    }
    
    .college-dropdown option[value="other"] {
        border-top: 1px solid rgba(255, 255, 255, 0.2);
        margin-top: 0.25rem;
        padding-top: 0.75rem;
        font-weight: 600;
        color: #0d6efd;
        background: linear-gradient(135deg, rgba(13, 110, 253, 0.1), rgba(13, 110, 253, 0.05));
    }
    
    /* Custom Input for Manual Entry */
    .college-custom-input {
        border: 2px solid #28a745;
        border-radius: 0.5rem;
        padding: 0.65rem 0.75rem;
        font-size: 0.95rem;
        transition: all 0.3s ease;
        background-color: rgba(40, 167, 69, 0.08);
        color: inherit;
    }
    
    .college-custom-input:focus {
        border-color: #28a745;
        box-shadow: 0 0 0 0.25rem rgba(40, 167, 69, 0.25);
        outline: none;
        background-color: rgba(40, 167, 69, 0.12);
    }
    
    .college-custom-input::placeholder {
        color: rgba(255, 255, 255, 0.5);
        font-style: italic;
    }
    
    /* Invalid State Styling */
    .college-dropdown.is-invalid,
    .college-custom-input.is-invalid {
        border-color: #dc3545;
        animation: shake 0.3s ease;
    }
    
    .college-dropdown.is-invalid:focus,
    .college-custom-input.is-invalid:focus {
        border-color: #dc3545;
        box-shadow: 0 0 0 0.25rem rgba(220, 53, 69, 0.25);
    }
    
    @keyframes shake {
        0%, 100% { transform: translateX(0); }
        25% { transform: translateX(-5px); }
        75% { transform: translateX(5px); }
    }
    
    /* Search Input Styling - Dark Mode */
    .college-search-input {
        padding: 0.6rem 0.75rem;
        border: 1.5px solid rgba(255, 255, 255, 0.2);
        border-radius: 0.5rem;
        font-size: 0.9rem;
        transition: all 0.3s ease;
        background: rgba(255, 255, 255, 0.05);
        color: inherit;
    }
    
    .college-search-input:focus {
        border-color: #0d6efd;
        box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.15);
        outline: none;
        background: rgba(255, 255, 255, 0.08);
    }
    
    .college-search-input::placeholder {
        color: rgb(255, 255, 255);
    }
    
    .search-icon {
        color: rgba(255, 255, 255, 0.6);
    }
    
    /* Input Group Styling for Dark Mode */
    .input-group-text {
        background-color: rgba(255, 255, 255, 0.05);
        border-color: rgba(255, 255, 255, 0.2);
        color: inherit;
    }
    
    /* Results Count Badge */
    .search-results-badge {
        display: inline-block;
        padding: 0.25rem 0.5rem;
        font-size: 0.75rem;
        border-radius: 0.375rem;
        background: rgba(13, 110, 253, 0.2);
        color: #0d6efd;
        font-weight: 600;
        margin-left: 0.5rem;
    }
</style>

{% endblock %}

{% block body %}

<div class="container-fluid">

    {% for message in messages %}

    <div class="alert {{ message.tags }} alert-dismissible fade show" role="alert">
        <strong>{{ message.tag }}</strong> {{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>

    {% endfor %}

    <!-- ===============================================================================================-->
    <!-- ============================================ JOVAC ARCHIVED ===================================-->
    <!-- ===============================================================================================-->

    <div class="card mb-4">
        <div class="card-header" style="cursor: pointer;" data-bs-toggle="collapse" data-bs-target="#jovacArchiveSection" aria-expanded="false" aria-controls="jovacArchiveSection">
            <div class="d-flex justify-content-between align-items-center">
                <h3 class="heading">
                    <span class="fw-semibold">J O V A C üìÅ</span>
                    <span class="fs-4 text-muted"> | Archived Courses
                    </span>
                    <small class="badge bg-secondary ms-2">Archived</small>
                </h3>
                
                <i class="fas fa-chevron-down transition-icon" id="jovacToggleIcon"></i>
            </div>
        </div>
        
        <div class="collapse" id="jovacArchiveSection">
            <div class="card-body">
                <!-- =========================================== APPROVED JOVAC COURSES =========================== -->
                <div class="row row-cols-1 row-cols-md-3 g-4">
                    {% for course in approved_courses %}
                    <div class="col-md-3">
                        <h5 class="card-title fw-semibold mb-0"></h5>
                        <div class="card position-relative">
                            <!-- Archived overlay -->
                            <div class="position-absolute top-0 end-0 m-2">
                                <span class="badge bg-dark">Archived</span>
                            </div>
                            <a href="{% url 'student_jovac' course.slug %}" class="text-decoration-none">
                                <img src="{{ course.thumbnail.url }}" class="card-img-top" alt="JOVAC Thumbnail" style="opacity: 0.8;" />
                                <div class="card-body">
                                    <h5 class="">
                                        {{ course.name }}üìÅ
                                    </h5>
                                    By: <p class="card-text">
                                         {{ course.get_instructor_names }}
                                    </p>
          
                                    <a href="{% url 'student_jovac' course.slug %}" class="btn btn-outline-secondary w-100">View Archive</a>
                                </div>
                            </a>
                        </div>
                    </div>
                    {% endfor %}

                    <!-- ====================================== PENDING JOVAC ======================================== -->
                    {% for course in pending_courses %}
                    <div class="col-md-3">
                        <div class="card position-relative">
                            <div class="position-absolute top-0 end-0 m-2">
                                <span class="badge bg-secondary">Archived</span>
                            </div>
                            <img src="{{ course.thumbnail.url }}" class="card-img-top" alt="course Thumbnail" style="opacity: 0.8;" />
                            <div class="card-body">
                                <h5 class="card-title text-muted">{{ course.name }}üìÅ</h5>
                                By: <p class="card-text text-muted fs-6 mb-2">
                                         {{ course.get_instructor_names }}
                                    </p>
                                <button class="btn btn-outline-secondary w-100" disabled>Was Requested</button>
                            </div>
                        </div>
                    </div>
                    {% endfor %}

                    <!-- ====================================== REJECTED JOVAC ======================================== -->
                    {% for course in rejected_courses %}
                    <div class="col-md-3">
                        <div class="card position-relative">
                            <div class="position-absolute top-0 end-0 m-2">
                                <span class="badge bg-secondary">Archived</span>
                            </div>
                            <img src="{{ course.thumbnail.url }}" class="card-img-top" alt="course Thumbnail" style="opacity: 0.8;" />
                            <div class="card-body">
                                <h5 class="card-title text-muted">{{ course.name }}üìÅ</h5>
                                <button class="btn btn-outline-secondary w-100" disabled>Was Rejected</button>
                            </div>
                        </div>
                    </div>
                    {% endfor %}

                    <!-- ====================================== ALL OTHER JOVAC ======================================== -->
                    {% for course in other_courses %}
                    <div class="col-md-3">
                        <div class="card position-relative">
                            <div class="position-absolute top-0 end-0 m-2">
                                <span class="badge bg-secondary">Archived</span>
                            </div>
                            <a href="#" class="text-decoration-none">
                                <img src="{{ course.thumbnail.url }}" class="card-img-top" alt="course Thumbnail" style="opacity: 0.8;" />
                                <div class="card-body">
                                    <h5 class="card-title text-muted">{{ course.name }}üìÅ</h5>
                                     By: <p class="card-text text-muted fs-6 mb-2">
                                         {{ course.get_instructor_names }}
                                    </p>
                                    <button class="btn btn-outline-secondary w-100" disabled>No Longer Available</button>
                                </div>
                            </a>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>

    <!-- ===============================================================================================-->
    <!-- =========================================== BATCHES ===========================================-->
    <!-- ===============================================================================================-->

    <div class="card">
        {% if student_batches %}
        <div class="card-body">
            <h3 class="heading">
                <span class="fw-semibold">M Y &nbsp; C O U R S E S üî•</span>
                <span class="fs-4"> | Angaar x W3Grads
                </span>
            </h3>
        </div>
        {% endif %}
    </div>

    <!-- ======================== COURSE CODE ====================== -->

    <div class="row row-cols-1 row-cols-md-3 g-4">

        {% for batch in student_batches %}

        <div class="col-md-3">
            <h5 class="card-title fw-semibold mb-0"></h5>
            <div class="card">
                <a href="{% url 'batch' batch.slug %}">
                    <img src="{{ batch.thumbnail.url }}" class="card-img-top" alt="Sheet Thumbnail" />
                    <div class="card-body">
                        <h5 class="card-title">
                            {{ batch.name }}üî•
                        </h5>
                        <!-- <p class="card-text mb-2">
                            Total Sawal : {{ sheet.get_total_questions }}
                        </p> -->
                        <!-- <p class="card-text text-black mb-1">
                            Total Registrations: {{ company.job_set.all }}
                        </p> -->
                        <a href="{% url 'batch' batch.slug %}" class="btn btn-outline-secondary w-100">View More</a>
                    </div>
                </a>
            </div>
        </div>

        {% endfor %}

    </div>

    <!-- ======================== ALL BATCH DATA TABLE ====================== -->

    <div class="card">

        {% if pending_batches or other_batches or rejected_batches %}

        <div class="card-body">
            <h3 class="heading">
                <span class="fw-semibold">A L L &nbsp; C O U R S E S üî•</span>
                <span class="fs-4"> | Angaar x W3Grads
                </span>
            </h3>
        </div>

        {% endif %}
    </div>

    <!-- ======================== COURSE CODE ====================== -->

    <div class="row row-cols-1 row-cols-md-3 g-4">

        {% for batch in pending_batches %}

        <div class="col-md-3">
            <div class="card">
                <img src="{{ batch.thumbnail.url }}" class="card-img-top" alt="Batch Thumbnail" />
                <div class="card-body">
                    <h5 class="card-title">{{ batch.name }}üî•</h5>
                    <button class="btn btn-outline-warning w-100" disabled>Requested</button>
                </div>
            </div>
        </div>

        {% endfor %}

        <!-- ====================== REJECTED BATCHES =================== -->

        {% for batch in rejected_batches %}

        <div class="col-md-3">
            <div class="card">
                <img src="{{ batch.thumbnail.url }}" class="card-img-top" alt="Batch Thumbnail" />
                <div class="card-body">
                    <h5 class="card-title">{{ batch.name }}üî•</h5>
                    <button class="btn btn-danger w-100" disabled>Rejected</button>
                </div>
            </div>
        </div>

        {% endfor %}

        <!-- ====================== ALL OTHER BATCHES ================ -->

        {% for batch in other_batches %}
        <div class="col-md-3">
            <div class="card">
                <a href="#">
                    <img src="{{ batch.thumbnail.url }}" class="card-img-top" alt="Batch Thumbnail" />
                    <div class="card-body">
                        <h5 class="card-title">{{ batch.name }}üî•</h5>

                        {% if batch.required_fields %}
                        <!-- If extra fields exist, open modal -->
                        <button class="btn btn-success w-100 enroll-btn" data-bs-toggle="modal"
                            data-bs-target="#enrollModal" data-batch-id="{{ batch.id }}"
                            data-batch-name="{{ batch.name }}" data-required-fields="{{ batch.required_fields|safe }}">
                            Enroll Now
                        </button>

                        <p class="text-success mt-2">Require Extra Info!</p>

                        {% else %}
                        <!-- Direct enrollment if no extra fields -->
                        <a href="{% url 'enroll_batch' batch.id %}" class="btn btn-success w-100">Enroll Now</a>
                        {% endif %}

                    </div>
                </a>
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- Enrollment Modal -->
    <div class="modal fade" id="enrollModal" tabindex="-1" aria-labelledby="enrollModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="enrollModalLabel">Enroll in <span id="modalBatchName"></span></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form id="enrollForm" method="POST">
                    {% csrf_token %}
                    <div class="modal-body">
                        <input type="hidden" name="batch_id" id="modalBatchId">
                        <div id="extraFieldsContainer"></div>
                    </div>
                    <div class="modal-footer">
                        <button type="submit" class="btn btn-primary">Submit</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>


<script>
    document.addEventListener("DOMContentLoaded", function () {
        const enrollButtons = document.querySelectorAll(".enroll-btn");
        const modalBatchName = document.getElementById("modalBatchName");
        const modalBatchId = document.getElementById("modalBatchId");
        const extraFieldsContainer = document.getElementById("extraFieldsContainer");
        const enrollForm = document.getElementById("enrollForm");

        // Handle JOVAC archive section toggle
        const jovacToggle = document.querySelector('[data-bs-target="#jovacArchiveSection"]');
        const jovacIcon = document.getElementById('jovacToggleIcon');
        
        if (jovacToggle) {
            jovacToggle.addEventListener('click', function() {
                const isExpanded = this.getAttribute('aria-expanded') === 'true';
                jovacIcon.style.transform = isExpanded ? 'rotate(0deg)' : 'rotate(180deg)';
            });
        }

        // Comprehensive list of Indian colleges and universities
        const collegesList = [
            // IITs
            "IIT Delhi", "IIT Bombay", "IIT Madras", "IIT Kanpur", "IIT Kharagpur",
            "IIT Roorkee", "IIT Guwahati", "IIT Hyderabad", "IIT Indore", "IIT BHU Varanasi",
            "IIT Gandhinagar", "IIT Ropar", "IIT Patna", "IIT Bhubaneswar", "IIT Jodhpur",
            "IIT Mandi", "IIT Palakkad", "IIT Tirupati", "IIT Dhanbad", "IIT Jammu",
            "IIT Goa", "IIT Dharwad", "IIT Bhilai",
            
            // NITs
            "NIT Trichy", "NIT Surathkal", "NIT Warangal", "NIT Calicut", "NIT Rourkela",
            "NIT Durgapur", "NIT Jaipur", "NIT Kurukshetra", "NIT Silchar", "NIT Hamirpur",
            "NIT Jalandhar", "NIT Allahabad", "NIT Bhopal", "NIT Jamshedpur", "NIT Raipur",
            "NIT Agartala", "NIT Arunachal Pradesh", "NIT Delhi", "NIT Goa", "NIT Meghalaya",
            "NIT Manipur", "NIT Mizoram", "NIT Nagaland", "NIT Patna", "NIT Puducherry",
            "NIT Sikkim", "NIT Srinagar", "NIT Uttarakhand", "NIT Andhra Pradesh",
            
            // IIITs
            "IIIT Hyderabad", "IIIT Allahabad", "IIIT Bangalore", "IIIT Delhi",
            "IIIT Gwalior", "IIIT Jabalpur", "IIIT Kota", "IIIT Vadodara",
            "IIIT Pune", "IIIT Kancheepuram", "IIIT Lucknow", "IIIT Nagpur",
            
            // DTU/NSUT
            "Delhi Technological University (DTU)", "Netaji Subhas University of Technology (NSUT)",
            
            // Other Major Universities - Delhi NCR
            "Indraprastha Institute of Information Technology Delhi (IIIT-D)",
            "Guru Gobind Singh Indraprastha University (GGSIPU)",
            "Jamia Millia Islamia", "Jawaharlal Nehru University",
            "Ambedkar University Delhi", "Delhi University",
            "Amity University Noida", "Shiv Nadar University",
            "Bennett University Greater Noida", "Ashoka University",
            "JIIT Noida", "JIMS Noida", "GTBIT Delhi",
            "Maharaja Agrasen Institute of Technology", "NSIT Delhi",
            "Indira Gandhi Delhi Technical University for Women (IGDTUW)",
            "Bharati Vidyapeeth's College of Engineering",
            "Netaji Subhas Institute of Technology (NSIT)",
            "Anand College Delhi (ANDC)",
            "Laxmibai College Delhi",
            "KCC Institute of Technology & Management",
            "Greater Noida Institute of Technology (GNIOT)",
            "Galgotias College of Engineering and Technology",

            
            // Uttar Pradesh
            "GLA University Mathura", "GL Bajaj Institute of Technology and Management Mathura",
            "BSA College of Engineering and Technology Mathura",
            "AKGEC Ghaziabad", "Ajay Kumar Garg Engineering College",
            "IMS Engineering College Ghaziabad",
            "IET Lucknow", "KNIT Sultanpur", "MMMUT Gorakhpur",
            "BIT Mesra", "HBTU Kanpur", "Galgotias University",
            "Sharda University", "Aligarh Muslim University",
            
            // Maharashtra
            "VJTI Mumbai", "COEP Pune", "PICT Pune", "SPIT Mumbai",
            "DJ Sanghvi College of Engineering", "KJ Somaiya College of Engineering",
            "Sardar Patel Institute of Technology", "Ramrao Adik Institute of Technology",
            "MIT Pune", "VIT Pune", "IIIT Pune",
            
            // Karnataka
            "RVCE Bangalore", "BMS College of Engineering", "PES University",
            "MS Ramaiah Institute of Technology", "Dayananda Sagar College of Engineering",
            "JSS Science and Technology University", "NMIT Bangalore",
            
            // Tamil Nadu
            "Anna University", "PSG College of Technology", "Thiagarajar College of Engineering",
            "SSN College of Engineering", "SRM University", "VIT Vellore",
            "Amrita Vishwa Vidyapeetham",
            
            // Telangana
            "BITS Pilani Hyderabad Campus", "Vasavi College of Engineering",
            "CVR College of Engineering", "CBIT Hyderabad",
            "Osmania University", "JNTUH",
            
            // Rajasthan
            "BITS Pilani", "Manipal University Jaipur", "Poornima University",
            "LNM Institute of Information Technology", "MBM Engineering College Jodhpur",
            "UEM Jaipur",
            
            // Uttarakhand
            "Tula's Institute Dehradun", "Graphic Era University",
            "DIT University", "UPES Dehradun",
            
            // Gujarat
            "DAIICT Gandhinagar", "Nirma University", "LDCE Ahmedabad",
            "SVNIT Surat", "GEC Gandhinagar",
            
            // West Bengal
            "Jadavpur University", "Heritage Institute of Technology",
            "Techno India", "Kalyani Government Engineering College",
            
            // Other States
            "Thapar University Patiala", "Chitkara University",
            "LPU Jalandhar", "PEC Chandigarh",
            "Manipal Institute of Technology", "Christ University Bangalore",
            "Sikkim Manipal Institute of Technology"
        ].sort();

        enrollButtons.forEach(button => {
            button.addEventListener("click", function () {
                const batchId = this.getAttribute("data-batch-id");
                const batchName = this.getAttribute("data-batch-name");
                let requiredFields = this.getAttribute("data-required-fields");
                // convert requiredFields to JSON parsable string
                requiredFields = requiredFields.replace(/'/g, '"');

                try {
                    requiredFields = JSON.parse(requiredFields);  // Properly parse JSON
                    console.log(requiredFields);
                } catch (e) {
                    requiredFields = [];  // Fallback to empty array if invalid
                    alert("Invalid required fields data");
                }

                // Set batch name and ID
                modalBatchName.textContent = batchName;
                modalBatchId.value = batchId;

                // Generate required fields dynamically
                extraFieldsContainer.innerHTML = "";
                requiredFields.forEach(field => {
                    let label = field.replace(/_/g, " ").toUpperCase();
                    
                    // Special handling for college_name field
                    if (field.toLowerCase() === 'college_name') {
                        extraFieldsContainer.innerHTML += `
                            <div class="mb-3">
                                <label class="form-label">
                                    ${label} <span class="text-danger">*</span>
                                    <span id="results_badge_${field}" class="search-results-badge" style="display: none;">
                                        <i class="fas fa-check-circle"></i> 0 found
                                    </span>
                                </label>
                                
                                <!-- Search input with icon -->
                                <div class="input-group mb-2">
                                    <span class="input-group-text">
                                        <i class="fas fa-search search-icon"></i>
                                    </span>
                                    <input type="text" 
                                           id="college_search_${field}" 
                                           class="form-control college-search-input" 
                                           placeholder="üîç Search from ${collegesList.length}+ colleges..." 
                                           autocomplete="off">
                                </div>
                                
                                <!-- Dropdown with all colleges -->
                                <select name="${field}" id="college_select_${field}" class="form-control college-dropdown" required size="6">
                                    <option value="" disabled selected>üëá Select your college from below</option>
                                    ${collegesList.map(college => `<option value="${college}">${college}</option>`).join('')}
                                    <option value="other">‚úèÔ∏è Other (Enter Manually)</option>
                                </select>
                                <small class="text-muted d-block mt-1">
                                    <i class="fas fa-info-circle"></i> Can't find your college? Select "Other" to enter manually
                                </small>
                                
                                <!-- Custom input for manual entry -->
                                <input type="text" 
                                       name="${field}_custom" 
                                       id="college_custom_${field}" 
                                       class="form-control mt-2 college-custom-input" 
                                       placeholder="‚úèÔ∏è Enter your college name here..." 
                                       style="display: none;">
                            </div>
                        `;
                    } else {
                        // Regular text input for other fields
                        extraFieldsContainer.innerHTML += `
                            <div class="mb-3">
                                <label class="form-label">${label}</label>
                                <input type="text" placeholder="Enter your ${label} here..." name="${field}" class="form-control" required>
                            </div>
                        `;
                    }
                });

                // Add event listeners for college search functionality
                const collegeSearchInputs = document.querySelectorAll('[id^="college_search_"]');
                collegeSearchInputs.forEach(searchInput => {
                    const fieldName = searchInput.id.replace('college_search_', '');
                    const dropdown = document.getElementById(`college_select_${fieldName}`);
                    const resultsBadge = document.getElementById(`results_badge_${fieldName}`);
                    
                    searchInput.addEventListener('input', function() {
                        const searchTerm = this.value.toLowerCase().trim();
                        const options = dropdown.querySelectorAll('option');
                        let visibleCount = 0;
                        
                        options.forEach(option => {
                            if (option.value === '' || option.value === 'other') {
                                // Always show the placeholder and "Other" option
                                option.style.display = '';
                                return;
                            }
                            
                            const collegeText = option.textContent.toLowerCase();
                            if (collegeText.includes(searchTerm)) {
                                option.style.display = '';
                                visibleCount++;
                            } else {
                                option.style.display = 'none';
                            }
                        });
                        
                        // Update results badge
                        if (searchTerm.length > 0) {
                            resultsBadge.style.display = 'inline-block';
                            resultsBadge.innerHTML = `<i class="fas fa-check-circle"></i> ${visibleCount} found`;
                        } else {
                            resultsBadge.style.display = 'none';
                        }
                        
                        // Auto-select if only one college matches
                        if (visibleCount === 1 && searchTerm.length > 2) {
                            const visibleOption = Array.from(options).find(opt => 
                                opt.style.display !== 'none' && opt.value !== '' && opt.value !== 'other'
                            );
                            if (visibleOption) {
                                dropdown.value = visibleOption.value;
                                // Add visual feedback
                                dropdown.style.borderColor = '#28a745';
                                setTimeout(() => {
                                    dropdown.style.borderColor = '';
                                }, 1000);
                            }
                        }
                    });
                    
                    // Clear search when dropdown is selected
                    dropdown.addEventListener('change', function() {
                        searchInput.value = '';
                        resultsBadge.style.display = 'none';
                        // Reset all options visibility
                        const options = dropdown.querySelectorAll('option');
                        options.forEach(option => {
                            option.style.display = '';
                        });
                    });
                    
                    // Keyboard navigation: Enter key to focus dropdown
                    searchInput.addEventListener('keydown', function(e) {
                        if (e.key === 'Enter') {
                            e.preventDefault();
                            const visibleOptions = Array.from(dropdown.querySelectorAll('option')).filter(opt => 
                                opt.style.display !== 'none' && opt.value !== '' && opt.value !== 'other'
                            );
                            
                            if (visibleOptions.length === 1) {
                                // Auto-select the only visible option
                                dropdown.value = visibleOptions[0].value;
                                dropdown.dispatchEvent(new Event('change'));
                            } else if (visibleOptions.length > 0) {
                                // Focus the dropdown for manual selection
                                dropdown.focus();
                            }
                        } else if (e.key === 'Escape') {
                            // Clear search on Escape
                            this.value = '';
                            this.dispatchEvent(new Event('input'));
                        }
                    });
                });
                
                // Add event listeners for college dropdown changes
                const collegeDropdowns = document.querySelectorAll('.college-dropdown');
                collegeDropdowns.forEach(dropdown => {
                    dropdown.addEventListener('change', function() {
                        const fieldName = this.name;
                        const customInput = document.getElementById(`college_custom_${fieldName}`);
                        
                        if (this.value === 'other') {
                            // Show custom input and make it required
                            customInput.style.display = 'block';
                            customInput.required = true;
                            this.required = false;
                            // Clear the dropdown selection to avoid confusion
                            this.value = '';
                        } else {
                            // Hide custom input and make dropdown required
                            customInput.style.display = 'none';
                            customInput.required = false;
                            customInput.value = '';
                            this.required = true;
                        }
                    });
                });

                // Update form action dynamically
                enrollForm.action = `/dashboard/enroll_course/${batchId}/`;
            });
        });

        // Form validation on submit
        enrollForm.addEventListener('submit', function(e) {
            const collegeDropdowns = document.querySelectorAll('.college-dropdown');
            let isValid = true;
            let errorMessage = '';

            collegeDropdowns.forEach(dropdown => {
                const fieldName = dropdown.name;
                const customInput = document.getElementById(`college_custom_${fieldName}`);
                
                // Check if both dropdown and custom input are empty
                if ((!dropdown.value || dropdown.value === '') && (!customInput.value || customInput.value.trim() === '')) {
                    isValid = false;
                    errorMessage = 'Please select a college from the dropdown or enter it manually.';
                    dropdown.classList.add('is-invalid');
                    if (customInput.style.display !== 'none') {
                        customInput.classList.add('is-invalid');
                    }
                } else {
                    dropdown.classList.remove('is-invalid');
                    customInput.classList.remove('is-invalid');
                }
            });

            if (!isValid) {
                e.preventDefault();
                alert(errorMessage);
                return false;
            }
        });
    });

</script>

{% endblock %}