{% extends 'home/base.html' %}
{% load static %}

{% block title %}
#ANGAARI_HAI | Registerüî•
{% endblock %}

{% block css %}
<link rel="stylesheet" href="{% static 'css/accounts/register.css' %}">
<link rel="stylesheet" href="{% static 'css/home/css/index.css' %}">

<link
  href="https://fonts.googleapis.com/css2?family=Montserrat:wght@700;900&family=Poppins:wght@300;500;600;700&display=swap"
  rel="stylesheet">


{% endblock %}

{% block body %}
<div id="bg-wrap" aria-hidden="true">
  <canvas id="fire-canvas"></canvas>
  <div class="pattern-overlay"></div>
</div>

<div class="register-main-wrapper">
  <div class="register-content">
    <section class="hero fade-in">
      <div class="kicker">üöÄ Join The Movement</div>
      <h1 class="hero-title">IGNITE YOUR CODING JOURNEY</h1>
      <p class="lead-text">Join a community that turns curiosity into mastery through hands-on projects, mentor-led
        sessions, interview practice and placement guidance.</p>

      <div class="hero-stats">
        <div class="stat-badge">üöÄ 20000+ Graduates</div>
        <div class="stat-badge">üèÜ Placement-Ready</div>
        <div class="stat-badge">üî• Live Projects</div>
      </div>
    </section>
    <!-- Hero Section -->

    <!-- Registration Card -->
    <div class="register-card fade-in delay-1">
      <div class="card-title">Step Forward To Learn and Earn</div>
      <div class="card-subtitle">Seekhna Hai, Seekh! Jeetna Hai, Jeet!</div>

      <!-- Django Messages -->
      {% if messages %}
      <div class="messages-container">
        {% for message in messages %}
        <div class="alert {{ message.tags }}" role="alert">
          <strong>{{ message.tags|title }}:</strong> {{ message }}
        </div>
        {% endfor %}
      </div>
      {% endif %}

      <!-- Registration Form -->
      <form method="post" role="form" novalidate>
        {% csrf_token %}

        <div class="form-group">
          <label for="username" class="form-label required">Username</label>
          <input type="text" class="form-input" id="username" name="username" placeholder="Enter your username"
            pattern="^(?!.*\s).{4,30}$" maxlength="30" minlength="4"
            title="Must NOT contain spaces, must be between 4-30 characters" required>
          <div id="username-feedback" class="feedback"></div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="first_name" class="form-label required">First Name</label>
            <input type="text" class="form-input" name="first_name" maxlength="30"
              placeholder="Enter your First name..." required>
          </div>

          <div class="form-group">
            <label for="last_name" class="form-label">Last Name</label>
            <input type="text" class="form-input" name="last_name" maxlength="20" placeholder="Enter your Last name...">
          </div>
        </div>

        <div class="form-group">
          <label for="email" class="form-label required">Email Address</label>
          <input type="email" class="form-input" name="email" id="email" maxlength="60" required
            placeholder="Enter your Email here...">
          <div id="email-feedback" class="feedback"></div>
        </div>

        <div class="password-row">
          <div class="form-group">
            <label for="password" class="form-label required">Password</label>
            <input type="password" class="form-input" name="password" id="password" minlength="8" required
              pattern="^(?=.*\d)(?=.*[a-z])(?=.*[A-Z])(?=.*[!@#$%^&*]).{8,}$" placeholder="Enter your Password..."
              title="Must contain at least one number, one uppercase, one lowercase, one special character, and at least 8 characters">
          </div>

          <div class="form-group">
            <label for="confirm_password" class="form-label required">Confirm Password</label>
            <input type="password" class="form-input" name="confirm_password"
              placeholder="Enter the same password again..." id="confirm-password" required>
          </div>

          <div id="password-match" class="password-match-error">Passwords do not match!</div>
        </div>

        <button type="submit" class="submit-btn" id="signup-button" disabled>Register</button>

        <div class="divider">
          <span>OR</span>
        </div>

        <a href="/accounts/social/google/login/?process=connect" class="google-btn">
          <svg class="google-icon" viewBox="0 0 48 48" xmlns="http://www.w3.org/2000/svg">
            <path fill="#EA4335"
              d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z">
            </path>
            <path fill="#4285F4"
              d="M46.98 24.55c0-1.57-.15-3.09-.42-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z">
            </path>
            <path fill="#FBBC05"
              d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z">
            </path>
            <path fill="#34A853"
              d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.15 1.45-4.92 2.3-8.16 2.3-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z">
            </path>
            <path fill="none" d="M0 0h48v48H0z"></path>
          </svg>
          Sign up with Google
        </a>

        <div class="login-link">
          Already an <span class="angaari-highlight"
            title="Angaari is a Hindi word meaning 'fiery' or 'burning'">Angaari?</span>
          <a href="{% url 'login' %}">Login</a>
        </div>
      </form>
    </div>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<script id="vertexShader" type="x-shader/x-vertex">
varying vec2 vUv;
void main() {
  vUv = uv;
  gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
}
</script>

<script id="fragmentShader" type="x-shader/x-fragment">
uniform vec3 color1;
uniform vec3 color2;
uniform float time;
varying vec2 vUv;

float random (vec2 st) {
    return fract(sin(dot(st.xy, vec2(12.9898,78.233))) * 43758.5453123);
}

float noise (vec2 st) {
    vec2 i = floor(st);
    vec2 f = fract(st);
    float a = random(i);
    float b = random(i + vec2(1.0, 0.0));
    float c = random(i + vec2(0.0, 1.0));
    float d = random(i + vec2(1.0, 1.0));
    vec2 u = f * f * (3.0 - 2.0 * f);
    return mix(a, b, u.x) + (c - a)* u.y * (1.0 - u.x) + (d - b) * u.x * u.y;
}

float fbm(vec2 st) {
    float value = 0.0;
    float amplitude = 0.5;
    for (int i = 0; i < 6; i++) {
        value += amplitude * noise(st);
        st *= 2.0;
        amplitude *= 0.5;
    }
    return value;
}

void main() {
    vec2 st = vUv;
    st.y *= 2.0;
    
    float T = time * 0.4;
    vec2 q = vec2(fbm(st + T * 0.01), fbm(st + vec2(1.0)));
    vec2 r = vec2(fbm(st + q * 2.0 + T * 0.1), fbm(st + q * 1.5 + T * 0.05));
    
    float f = fbm(st + r);
    
    float fireShape = 1.0 - smoothstep(0.1, 1.0, st.y);
    f *= fireShape;
    
    vec3 color = mix(color1, color2, clamp((f*f)*4.0, 0.0, 1.0));
    
    gl_FragColor = vec4(color, f * f * f * 2.5);
}
</script>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    // ===============================================================
    // THREE.JS FIRE IMPLEMENTATION
    // ===============================================================
    let scene, camera, renderer, fireMesh, clock;

    function init3D() {
      const canvas = document.getElementById('fire-canvas');
      scene = new THREE.Scene();
      clock = new THREE.Clock();
      camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
      camera.position.z = 2.5;
      renderer = new THREE.WebGLRenderer({ canvas, alpha: true });
      renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
      onWindowResize();
      const fireGeometry = new THREE.PlaneGeometry(10, 5, 32, 32);
      const fireMaterial = new THREE.ShaderMaterial({
        uniforms: {
          time: { value: 0.0 },
          color1: { value: new THREE.Color('#ff4f0f') },
          color2: { value: new THREE.Color('#ff6a00') },
        },
        vertexShader: document.getElementById('vertexShader').textContent,
        fragmentShader: document.getElementById('fragmentShader').textContent,
        transparent: true,
        blending: THREE.AdditiveBlending,
        depthWrite: false
      });
      fireMesh = new THREE.Mesh(fireGeometry, fireMaterial);
      scene.add(fireMesh);
      window.addEventListener('resize', onWindowResize);
      document.addEventListener('pointermove', onPointerMove);
      animate();
    }

    function onWindowResize() {
      camera.aspect = window.innerWidth / window.innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(window.innerWidth, window.innerHeight);
    }

    function onPointerMove(event) {
      if (fireMesh) {
        const mouseX = (event.clientX / window.innerWidth) * 2 - 1;
        const mouseY = -(event.clientY / window.innerHeight) * 2 + 1;
        camera.rotation.y = (mouseX * 0.1 - camera.rotation.y) * 0.05;
        camera.rotation.x = (mouseY * 0.1 - camera.rotation.x) * 0.05;
      }
    }

    let rafId;
    function animate() {
      const elapsedTime = clock.getElapsedTime();
      fireMesh.material.uniforms.time.value = elapsedTime;
      renderer.render(scene, camera);
      rafId = requestAnimationFrame(animate);
    }

    document.addEventListener('visibilitychange', () => {
      if (document.hidden) {
        cancelAnimationFrame(rafId);
      } else {
        animate();
      }
    });

    init3D();

    // ===============================================================
    // DJANGO FORM VALIDATION (AJAX)
    // ===============================================================

    $(document).ready(function () {
      // Username availability check
      $("#username").on("input", function () {
        let username = $(this).val();
        if (username.length >= 4) {
          $.ajax({
            url: "{% url 'check_username_availability' %}",
            data: { 'username': username },
            dataType: 'json',
            success: function (data) {
              if (data.is_available) {
                $("#username-feedback").html("<span class='success'>Username is available</span>");
                enableSubmit();
              } else {
                $("#username-feedback").html("<span class='error'>Username is taken</span>");
                disableSubmit();
              }
            },
            error: function () {
              $("#username-feedback").html("<span class='error'>Error checking username</span>");
              disableSubmit();
            }
          });
        } else {
          $("#username-feedback").empty();
          disableSubmit();
        }
      });

      // Email availability check
      $("#email").on("input", function () {
        let email = $(this).val();
        if (email.length > 5 && validateEmail(email)) {
          $.ajax({
            url: "{% url 'check_email_availability' %}",
            data: { 'email': email },
            dataType: 'json',
            success: function (data) {
              if (data.is_available) {
                $("#email-feedback").html("<span class='success'>Email is available</span>");
                enableSubmit();
              } else {
                $("#email-feedback").html("<span class='error'>Email already registered</span>");
                disableSubmit();
              }
            },
            error: function () {
              $("#email-feedback").html("<span class='error'>Error checking email</span>");
              disableSubmit();
            }
          });
        } else {
          $("#email-feedback").empty();
          disableSubmit();
        }
      });

      // Password confirmation check
      $("#password, #confirm-password").on("input", function () {
        if ($("#password").val() !== $("#confirm-password").val()) {
          $("#password-match").show();
          disableSubmit();
        } else {
          $("#password-match").hide();
          enableSubmit();
        }
      });

      function validateEmail(email) {
        const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        return re.test(email);
      }

      function enableSubmit() {
        if (validForm()) {
          $("#signup-button").prop("disabled", false).text("Register");
        }
      }

      function disableSubmit() {
        $("#signup-button").prop("disabled", true).text("Cannot Register");
      }

      function validForm() {
        return $("#username-feedback").text().includes("available") &&
          $("#email-feedback").text().includes("available") &&
          $("#password-match").is(":hidden") &&
          $("#password").val().length >= 8 &&
          $("#confirm-password").val().length >= 8;
      }

      // Form submission handling
      $("form").on("submit", function () {
        $("#signup-button").text("Registering...").prop("disabled", true);
      });
    });

    
  });
</script>
{% endblock %}