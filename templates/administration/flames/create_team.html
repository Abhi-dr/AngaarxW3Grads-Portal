{% extends "administration/base.html" %}
{% block title %}Create New Team{% endblock %}
{% block flames_active %}active{% endblock %}

{% block extra_css %}
<style>
    .container-fluid {
        padding: 2rem;
        max-width: 800px;
        margin: 0 auto;
    }

    .page-header {
        text-align: center;
        margin-bottom: 3rem;
        position: relative;
    }

    .page-title {
        font-size: 3rem;
        font-weight: 700;
        background: linear-gradient(45deg, #ff6b6b, #feca57, #ff9ff3, #54a0ff);
        background-size: 400% 400%;
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        animation: gradientShift 3s ease-in-out infinite;
        text-shadow: 0 0 30px rgba(255, 107, 107, 0.3);
        margin-bottom: 0.5rem;
    }

    .page-subtitle {
        color: rgba(255, 255, 255, 0.8);
        font-size: 1.2rem;
        margin-bottom: 2rem;
    }

    @keyframes gradientShift {

        0%,
        100% {
            background-position: 0% 50%;
        }

        50% {
            background-position: 100% 50%;
        }
    }

    .flame-icon {
        font-size: 2.5rem;
        margin-right: 1rem;
        animation: flicker 2s ease-in-out infinite alternate;
    }

    @keyframes flicker {
        0% {
            transform: rotate(-2deg) scale(1);
        }

        100% {
            transform: rotate(2deg) scale(1.1);
        }
    }

    .form-container {
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(15px);
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 25px;
        padding: 3rem;
        position: relative;
        overflow: hidden;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
    }

    .form-container::before {
        content: '';
        position: absolute;
        top: -50%;
        left: -50%;
        width: 200%;
        height: 200%;
        background: linear-gradient(45deg, transparent, rgba(255, 255, 255, 0.05), transparent);
        animation: shimmer 4s ease-in-out infinite;
        pointer-events: none;
    }

    @keyframes shimmer {
        0% {
            transform: rotate(0deg);
        }

        100% {
            transform: rotate(360deg);
        }
    }

    .form-group {
        margin-bottom: 2rem;
        position: relative;
    }

    .form-label {
        color: #feca57;
        font-weight: 600;
        font-size: 1.1rem;
        margin-bottom: 0.8rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .form-control,
    .form-select {
        background: rgba(255, 255, 255, 0.1);
        border: 2px solid rgba(255, 255, 255, 0.2);
        border-radius: 15px;
        padding: 1rem 1.5rem;
        color: white;
        font-size: 1rem;
        transition: all 0.3s ease;
        backdrop-filter: blur(5px);
    }

    .form-control:focus,
    .form-select:focus {
        background: rgba(255, 255, 255, 0.15);
        border-color: #feca57;
        box-shadow: 0 0 20px rgba(254, 202, 87, 0.3);
        color: white;
        outline: none;
    }

    .form-control::placeholder {
        color: rgba(255, 255, 255, 0.6);
    }

    .form-select option {
        background: #2d2d2d;
        color: white;
        padding: 0.5rem;
    }

    .form-text {
        color: rgba(255, 255, 255, 0.7);
        font-size: 0.9rem;
        margin-top: 0.5rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .btn-create {
        background: linear-gradient(45deg, #ff6b6b, #feca57);
        border: none;
        color: white;
        padding: 1rem 3rem;
        border-radius: 25px;
        font-size: 1.1rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 1px;
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
        box-shadow: 0 10px 30px rgba(255, 107, 107, 0.3);
    }

    .btn-create::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
        transition: left 0.5s;
    }

    .btn-create:hover::before {
        left: 100%;
    }

    .btn-create:hover {
        transform: translateY(-3px);
        box-shadow: 0 15px 40px rgba(255, 107, 107, 0.4);
        background: linear-gradient(45deg, #ff5252, #fdd835);
    }

    .btn-create:active {
        transform: translateY(-1px);
    }


    .member-counter {
        position: absolute;
        top: 10px;
        right: 15px;
        background: linear-gradient(45deg, #ff6b6b, #feca57);
        color: white;
        padding: 0.3rem 0.8rem;
        border-radius: 15px;
        font-size: 0.8rem;
        font-weight: 600;
        opacity: 0;
        transition: opacity 0.3s ease;
    }

    .member-counter.show {
        opacity: 1;
    }

    .form-group.has-selection .form-select {
        border-color: #00b894;
        box-shadow: 0 0 15px rgba(0, 180, 148, 0.3);
    }

    .validation-message {
        color: #ff6b6b;
        font-size: 0.9rem;
        margin-top: 0.5rem;
        display: none;
    }

    .validation-message.show {
        display: block;
    }

    @media (max-width: 768px) {
        .container-fluid {
            padding: 1rem;
        }

        .form-container {
            padding: 2rem;
        }

        .page-title {
            font-size: 2.5rem;
        }

        .progress-steps {
            flex-wrap: wrap;
            gap: 1rem;
        }
    }
</style>
{% endblock %}

{% block body %}

<div class="container-fluid">
    <div class="page-header">
        <h2 class="page-title">
            <i class="fas fa-fire flame-icon"></i>
            Create New Team
        </h2>
        <p class="page-subtitle">Build your dream team and ignite collaboration</p>
    </div>

    <div class="form-container">

        <form method="post" id="teamForm">
            {% csrf_token %}

            <div class="form-group">
                <label for="course" class="form-label">
                    <i class="fas fa-book"></i>
                    Select Course
                </label>
                <select class="form-select" name="course" id="course" required>
                    <option value="">-- Select a Course --</option>
                    {% for course in courses %}
                    <option value="{{ course.id }}">{{ course.title }}</option>
                    {% endfor %}
                </select>
                <div class="validation-message" id="courseError">Please select a course</div>
            </div>

            <div class="form-group">
                <label for="team_name" class="form-label">
                    <i class="fas fa-users"></i>
                    Team Name
                </label>
                <input type="text" class="form-control" id="team_name" name="team_name"
                    placeholder="Enter an awesome team name" required>
                <div class="validation-message" id="nameError">Please enter a team name</div>
            </div>

            <div class="form-group">
                <label for="members" class="form-label">
                    <i class="fas fa-user-friends"></i>
                    Select Members (Max 5)
                </label>

                <input type="text" class="form-control mb-2" id="searchMembersInput"
                    placeholder="Search by name or email..." onkeyup="filterMembers()">

                <div style="position: relative;">
                    <select class="form-select" id="members" name="members" multiple required>
                        <!-- Populated by JS -->
                    </select>
                    <div class="member-counter" id="memberCounter">0/5 selected</div>
                </div>

                <div class="form-text">
                    <i class="fas fa-info-circle"></i>
                    Use Ctrl (or Cmd) + Click to select multiple members
                </div>

                <div class="validation-message" id="membersError">Please select at least 2 members</div>
            </div>


            <div class="form-group">
                <label for="leader" class="form-label">
                    <i class="fas fa-crown"></i>
                    Select Team Leader
                </label>
                <select class="form-select" id="leader" name="leader" required>
                    <option value="">-- Select leader from members --</option>
                </select>
                <div class="validation-message" id="leaderError">Please select a team leader</div>
            </div>

            <div class="text-center">
                <button type="submit" class="btn-create">
                    <i class="fas fa-rocket me-2"></i>
                    Create Team
                </button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block myjs %}
<script>
    const membersDropdown = document.getElementById('members');
    const leaderDropdown = document.getElementById('leader');
    const courseDropdown = document.getElementById('course');
    const memberCounter = document.getElementById('memberCounter');
    const teamForm = document.getElementById('teamForm');
    const searchInput = document.getElementById('searchMembersInput');

    let allStudents = []; // Holds all students fetched from backend
    let selectedMemberIds = new Set(); // Tracks selected member IDs globally
    let currentStep = 1;

    const steps = document.querySelectorAll('.step');

    function updateProgress() {
        steps.forEach((step, index) => {
            const stepNumber = index + 1;
            if (stepNumber < currentStep) {
                step.classList.add('completed');
                step.classList.remove('active');
                step.innerHTML = '<i class="fas fa-check"></i>';
            } else if (stepNumber === currentStep) {
                step.classList.add('active');
                step.classList.remove('completed');
                step.innerHTML = stepNumber;
            } else {
                step.classList.remove('active', 'completed');
                step.innerHTML = stepNumber;
            }
        });
    }

    function updateMemberCounter() {
        const selectedCount = selectedMemberIds.size;
        memberCounter.textContent = `${selectedCount}/5 selected`;

        if (selectedCount > 0) {
            memberCounter.classList.add('show');
            membersDropdown.parentElement.parentElement.classList.add('has-selection');
        } else {
            memberCounter.classList.remove('show');
            membersDropdown.parentElement.parentElement.classList.remove('has-selection');
        }

        if (selectedCount > 0) {
            currentStep = Math.max(currentStep, 3);
        } else {
            currentStep = Math.min(currentStep, 2);
        }
        updateProgress();
    }

    function updateLeaderDropdown() {
        const previouslySelected = leaderDropdown.value;
        leaderDropdown.innerHTML = '<option value="">-- Select leader from members --</option>';

        Array.from(membersDropdown.options).forEach(option => {
            if (option.selected) {
                const leaderOption = document.createElement('option');
                leaderOption.value = option.value;
                leaderOption.textContent = option.textContent;
                leaderDropdown.appendChild(leaderOption);
            }
        });

        // Re-select previously selected leader if still in list
        if (previouslySelected) {
            const match = leaderDropdown.querySelector(`option[value="${previouslySelected}"]`);
            if (match) match.selected = true;
        }
    }

    function populateMembersDropdown(students) {
        membersDropdown.innerHTML = '';

        // Combine searched and previously selected students
        const selectedStudents = allStudents.filter(s => selectedMemberIds.has(s.id.toString()));
        const allVisible = [...new Map([...students, ...selectedStudents].map(s => [s.id, s])).values()];

        allVisible.forEach(student => {
            const option = document.createElement('option');
            option.value = student.id;
            option.textContent = `${student.first_name} ${student.last_name} (${student.email})`;
            option.dataset.name = `${student.first_name} ${student.last_name}`.toLowerCase();
            option.dataset.email = student.email.toLowerCase();
            if (selectedMemberIds.has(student.id.toString())) {
                option.selected = true;
            }
            membersDropdown.appendChild(option);
        });

        updateLeaderDropdown();
        updateMemberCounter();
    }

    function filterMembers() {
        const query = searchInput.value.toLowerCase().trim();
        const filtered = allStudents.filter(student =>
        (`${student.first_name} ${student.last_name}`.toLowerCase().includes(query) ||
            student.email.toLowerCase().includes(query))
        );
        populateMembersDropdown(filtered);
    }

    courseDropdown.addEventListener('change', function () {
        const courseId = this.value;

        membersDropdown.innerHTML = '';
        leaderDropdown.innerHTML = '<option value="">-- Select leader from members --</option>';
        selectedMemberIds.clear();
        searchInput.value = '';

        if (courseId) {
            currentStep = Math.max(currentStep, 1);
            this.parentElement.classList.add('has-selection');
        } else {
            currentStep = 1;
            this.parentElement.classList.remove('has-selection');
        }
        updateProgress();
        updateMemberCounter();

        if (!courseId) return;

        fetch(`/administration/get-available-students/${courseId}/`)
            .then(response => response.json())
            .then(data => {
                allStudents = data.students;
                populateMembersDropdown(allStudents);
            });
    });

    membersDropdown.addEventListener('change', function () {
        const selectedOptions = Array.from(this.selectedOptions);

        // Prevent more than 5 selections
        if (selectedOptions.length > 5) {
            selectedOptions[selectedOptions.length - 1].selected = false;
            alert('Maximum 5 members allowed per team!');
        }

        // Update selectedMemberIds
        selectedMemberIds = new Set(Array.from(this.selectedOptions).map(o => o.value));

        updateLeaderDropdown();
        updateMemberCounter();
    });

    searchInput.addEventListener('input', filterMembers);

    document.getElementById('team_name').addEventListener('input', function () {
        if (this.value.trim()) {
            currentStep = Math.max(currentStep, 2);
            this.parentElement.classList.add('has-selection');
        } else {
            this.parentElement.classList.remove('has-selection');
        }
        updateProgress();
    });

    leaderDropdown.addEventListener('change', function () {
        if (this.value) {
            currentStep = 4;
            this.parentElement.classList.add('has-selection');
        } else {
            currentStep = 3;
            this.parentElement.classList.remove('has-selection');
        }
        updateProgress();
    });

    teamForm.addEventListener('submit', function (e) {
        let isValid = true;

        document.querySelectorAll('.validation-message').forEach(msg => {
            msg.classList.remove('show');
        });

        if (!courseDropdown.value) {
            document.getElementById('courseError').classList.add('show');
            isValid = false;
        }

        if (!document.getElementById('team_name').value.trim()) {
            document.getElementById('nameError').classList.add('show');
            isValid = false;
        }

        if (selectedMemberIds.size < 2) {
            document.getElementById('membersError').classList.add('show');
            isValid = false;
        }

        if (!leaderDropdown.value) {
            document.getElementById('leaderError').classList.add('show');
            isValid = false;
        }

        if (!isValid) e.preventDefault();
    });

    updateProgress();
</script>
{% endblock %}