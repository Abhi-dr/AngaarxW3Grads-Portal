{% extends "administration/base.html" %}
{% load static %}

{% block title %}FLAMES '25 Registrations{% endblock %}

{% block flames_active %}active{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdn.datatables.net/1.11.5/css/dataTables.bootstrap5.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">

<style>
    .filter-section {
        background: #363636;
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 25px;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
    }

    .filter-title {
        font-size: 16px;
        font-weight: 600;
        margin-bottom: 15px;
        color: #333;
    }

    .filter-row {
        display: flex;
        gap: 15px;
        flex-wrap: wrap;
    }

    .filter-item {
        flex: 1;
        min-width: 200px;
    }

    .filter-buttons {
        display: flex;
        gap: 10px;
        margin-top: 15px;
    }

    .status-badge {
        padding: 5px 10px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 600;
        display: inline-block;
    }

    .status-pending {
        background-color: rgba(252, 190, 45, 0.2) !important;
        color: #fcbe2d !important;
    }

    .status-approved {
        background-color: rgba(56, 203, 137, 0.2) !important;
        color: #38cb89 !important;
    }

    .status-rejected {
        background-color: rgba(242, 78, 30, 0.2) !important;
        color: #f24e1e !important;
    }

    .status-completed {
        background-color: rgba(66, 115, 250, 0.2) !important;
        color: #4273FA !important;
    }

    .data-card {
        background-color: #363636;
        border-radius: 10px;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        margin-bottom: 25px;
    }

    .course-stats {
        display: flex;
        gap: 15px;
        margin-bottom: 25px;
    }

    .stat-card {
        background-color: #363636;
        border-radius: 10px;
        padding: 20px;
        flex: 1;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        display: flex;
        align-items: center;
    }

    .stat-icon {
        width: 50px;
        height: 50px;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
        color: white;
        margin-right: 15px;
    }

    .stat-total {
        background-color: rgba(66, 115, 250, 0.1);
        color: #4273FA;
    }

    .stat-pending {
        background-color: rgba(252, 190, 45, 0.1);
        color: #fcbe2d;
    }

    .stat-approved {
        background-color: rgba(56, 203, 137, 0.1);
        color: #38cb89;
    }

    .stat-info {
        display: flex;
        flex-direction: column;
    }

    .stat-value {
        font-size: 24px;
        font-weight: 700;
        color: #333;
    }

    .stat-label {
        font-size: 14px;
        color: #888;
    }

    .export-buttons {
        margin-bottom: 15px;
    }

    .course-badge {
        display: inline-block;
        padding: 4px 10px;
        border-radius: 5px;
        font-size: 12px;
        font-weight: 600;
        /* Make sure course badge is visible in dark mode */
        background-color: rgba(66, 115, 250, 0.15) !important;
        color: #4273FA !important;
    }

    .modal-details .detail-row {
        margin-bottom: 15px;
        background-color: #3a3a3a;
        padding: 10px;
        border-radius: 5px;
    }

    .modal-details .detail-label {
        font-weight: 700;
        color: #ffffff;
        font-size: 14px;
    }

    .modal-details .detail-value {
        font-size: 14px;
        color: #ffffff;
    }

    /* Base styles for length dropdown */
    .dataTables_wrapper .dataTables_length select {
        padding: 6px 10px;
        font-size: 14px;
        border-radius: 6px;
        border: 1px solid #ccc;
        background-color: #fff;
        color: #333;
        transition: all 0.3s ease;
        outline: none;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        cursor: pointer;
    }

    /* On focus */
    .dataTables_wrapper .dataTables_length select:focus {
        border-color: #007bff;
        box-shadow: 0 0 4px rgba(0, 123, 255, 0.4);
    }

    /* Dark mode styles */
    @media (prefers-color-scheme: dark) {
        .dataTables_wrapper .dataTables_length select {
            background-color: #1e1e1e;
            color: #f1f1f1;
            border: 1px solid #444;
            box-shadow: 0 1px 2px rgba(255, 255, 255, 0.05);
        }

        .dataTables_wrapper .dataTables_length select:focus {
            border-color: #66b2ff;
            box-shadow: 0 0 4px rgba(102, 178, 255, 0.4);
        }
    }


    @media (max-width: 768px) {
        .course-stats {
            flex-direction: column;
            gap: 10px;
        }

        .filter-row {
            flex-direction: column;
        }
    }

    .card {
        background-color: #363636;
        border: none;
        border-radius: 10px;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
    }

    .card-header {
        background-color: #424242;
        border-bottom: 1px solid #505050;
        padding: 15px 20px;
    }

    .card-title {
        margin: 0;
        font-size: 18px;
        font-weight: 600;
        color: #e0e0e0;
    }

    .form-control,
    .form-select {
        background-color: #3a3a3a;
        color: #f0f0f0;
        border: 1px solid #505050;
    }

    .filter-box {
        background-color: #424242;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
    }

    .filter-title {
        color: #e0e0e0;
        font-weight: 600;
    }

    .stat-card {
        background-color: #363636;
        border-radius: 10px;
        padding: 20px;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
    }

    .stat-value {
        color: #f0f0f0;
        font-weight: 700;
    }

    .stat-label {
        color: #b0b0b0;
    }

    /* Fix datatable colors */
    table.dataTable {
        color: #f0f0f0;
    }

    .dataTables_wrapper .dataTables_length,
    .dataTables_wrapper .dataTables_filter,
    .dataTables_wrapper .dataTables_info,
    .dataTables_wrapper .dataTables_processing,
    .dataTables_wrapper .dataTables_paginate {
        color: #e0e0e0;
    }

    .dataTables_wrapper .dataTables_paginate .paginate_button.disabled,
    .dataTables_wrapper .dataTables_paginate .paginate_button.disabled:hover,
    .dataTables_wrapper .dataTables_paginate .paginate_button.disabled:active {
        color: #909090 !important;
    }

    .dataTables_wrapper .dataTables_paginate .paginate_button {
        color: #e0e0e0 !important;
    }

    .dataTables_wrapper .dataTables_paginate .paginate_button.current,
    .dataTables_wrapper .dataTables_paginate .paginate_button.current:hover {
        color: #f0f0f0 !important;
        background: #424242;
        border-color: #505050;
    }

    .dataTables_wrapper .dataTables_paginate .paginate_button:hover {
        color: white !important;
        background: #505050;
        border-color: #606060;
    }

    /* Table styles for dark theme */
    .table {
        color: #f0f0f0;
    }

    .table-striped>tbody>tr:nth-of-type(odd) {
        background-color: rgba(255, 255, 255, 0.05);
    }

    .table-hover tbody tr:hover {
        background-color: rgba(255, 255, 255, 0.1);
    }

    /* Modal styles for dark theme */
    .modal-content {
        background-color: #363636;
        color: #f0f0f0;
    }

    .modal-header,
    .modal-footer {
        border-color: #505050;
        background-color: #424242;
    }

    .detail-label {
        color: #b0b0b0;
    }

    .detail-value {
        color: #f0f0f0;
    }

    /* Fix datatable pagination buttons */
    .page-link {
        background-color: #424242;
        border-color: #505050;
        color: #f0f0f0;
    }

    .page-item.active .page-link {
        background-color: #4273FA;
        border-color: #4273FA;
    }

    .page-item.disabled .page-link {
        background-color: #363636;
        border-color: #505050;
        color: #909090;
    }

    /* Make table headers more visible */
    table.dataTable thead th {
        background-color: #424242;
        color: #e0e0e0;
        border-color: #505050;
        padding: 12px 10px;
    }

    /* Fix table stripes in dark mode */
    table.dataTable.stripe tbody tr.odd,
    table.dataTable.display tbody tr.odd {
        background-color: #050505;
    }

    table.dataTable.stripe tbody tr.even,
    table.dataTable.display tbody tr.even {
        background-color: #000000;
    }

    /* Fix checkbox and radio button colors */
    .form-check-input {
        background-color: #3a3a3a;
        border-color: #505050;
    }

    .form-check-input:checked {
        background-color: #4273FA;
        border-color: #4273FA;
    }

    /* Base styles for search box */
    div.dataTables_wrapper div.dataTables_filter input {
        padding: 8px 12px;
        font-size: 14px;
        border-radius: 6px;
        border: 1px solid #ccc;
        background-color: #fff;
        color: #333;
        transition: all 0.3s ease;
        outline: none;
        width: 250px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    /* On focus */
    div.dataTables_wrapper div.dataTables_filter input:focus {
        border-color: #007bff;
        box-shadow: 0 0 5px rgba(0, 123, 255, 0.5);
    }

    /* Dark mode support using prefers-color-scheme */
    @media (prefers-color-scheme: dark) {
        div.dataTables_wrapper div.dataTables_filter input {
            background-color: #1e1e1e;
            color: #f1f1f1;
            border: 1px solid #444;
            box-shadow: 0 1px 3px rgba(255, 255, 255, 0.1);
        }

        div.dataTables_wrapper div.dataTables_filter input:focus {
            border-color: #66b2ff;
            box-shadow: 0 0 5px rgba(102, 178, 255, 0.5);
        }
    }
</style>
{% endblock %}

{% block body %}
<div class="container-fluid px-4">

    <div class="card">
        <div class="card-body d-flex justify-content-between align-items-center">
            <h3 class="heading">FLAMES Registrations</h3>
            <div class="export-buttons float-end">
                <a class="btn btn-success btn-sm" href="{% url 'export_flames_registrations_to_excel' %}">
                    <i class="fas fa-file-excel me-2"></i>Export Excel
                </a>
                <button class="btn btn-danger btn-sm" id="exportPDF">
                    <i class="fas fa-file-pdf me-2"></i>Export PDF
                </button>
            </div>
        </div>
    </div>

    <!-- Stats Cards -->
    <div class="course-stats">
        <div class="stat-card">
            <div class="stat-icon stat-total">
                <i class="fas fa-users"></i>
            </div>
            <div class="stat-info">
                <div class="stat-value">{{ total_registrations }}</div>
                <div class="stat-label">Total Registrations</div>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon stat-pending">
                <i class="fas fa-clock"></i>
            </div>
            <div class="stat-info">
                <div class="stat-value">{{ pending_registrations }}</div>
                <div class="stat-label">Pending</div>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon stat-approved">
                <i class="fas fa-check-circle"></i>
            </div>
            <div class="stat-info">
                <div class="stat-value">{{ approved_registrations }}</div>
                <div class="stat-label">Approved</div>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon stat-completed" style="background-color: rgba(66, 115, 250, 0.1); color: #4273FA;">
                <i class="fas fa-trophy"></i>
            </div>
            <div class="stat-info">
                <div class="stat-value">{{ completed_registrations }}</div>
                <div class="stat-label">Completed</div>
            </div>
        </div>
    </div>

    <!-- Filter Section -->
    <div class="filter-section">
        <h4 class="filter-title">Filter Registrations</h4>
        <form id="filterForm">
            <div class="filter-row">
                <div class="filter-item">
                    <label for="courseFilter" class="form-label">Course</label>
                    <select id="courseFilter" name="course" class="form-select">
                        <option value="">All Courses</option>
                        {% for course in courses %}
                        <option value="{{ course.id }}">{{ course.title }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="filter-item">
                    <label for="statusFilter" class="form-label">Status</label>
                    <select id="statusFilter" name="status" class="form-select">
                        <option value="all">All Statuses</option>
                        <option value="pending">Pending</option>
                        <option value="approved">Approved</option>
                        <option value="rejected">Rejected</option>
                        <option value="completed">Completed</option>
                    </select>
                </div>
                <div class="filter-item">
                    <label for="modeFilter" class="form-label">Registration Mode</label>
                    <select id="modeFilter" name="mode" class="form-select">
                        <option value="all">All Modes</option>
                        <option value="solo">Solo</option>
                        <option value="team">Team</option>
                    </select>
                </div>
                <div class="filter-item">
                    <label for="yearFilter" class="form-label">Year</label>
                    <select id="yearFilter" name="year" class="form-select">
                        <option value="">All Years</option>
                        <option value="1">1st Year</option>
                        <option value="2">2nd Year</option>
                        <option value="3">3rd Year</option>
                        <option value="4">4th Year</option>
                    </select>
                </div>
                <div class="filter-item">
                    <label for="collegeFilter" class="form-label">College</label>
                    <select id="collegeFilter" name="college" class="form-select">
                        <option value="">All Colleges</option>
                        {% for college in colleges %}
                        <option value="{{ college }}">{{ college }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            <div class="filter-buttons">
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-filter me-2"></i>Apply Filters
                </button>
                <button type="reset" class="btn btn-outline-secondary" id="resetFilters">
                    <i class="fas fa-undo me-2"></i>Reset
                </button>
            </div>
        </form>
    </div>

    <!-- Registrations Data Table -->
    <div class="data-card">
        <div class="card-body p-4">
            <table id="registrationsTable" class="table table-hover">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Name</th>
                        <th>Course</th>
                        <!-- <th>Email</th> -->
                        <th>Phone</th>
                        <th>College</th>
                        <th>Year</th>
                        <th>Mode</th>
                        <th>Team</th>
                        <th>Date</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
            </table>
        </div>
    </div>
</div>

<!-- Registration Details Modal -->
<div class="modal fade" id="registrationDetailsModal" tabindex="-1" aria-labelledby="registrationDetailsModalLabel"
    aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="registrationDetailsModalLabel">Registration Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="modal-details">
                    <!-- Student Information -->
                    <h6 class="mb-3">Student Information</h6>
                    <div class="row detail-row">
                        <div class="col-md-4">
                            <div class="detail-label">ID</div>
                            <div class="detail-value" id="reg-id"></div>
                        </div>
                        <div class="col-md-4">
                            <div class="detail-label">Name</div>
                            <div class="detail-value" id="reg-name"></div>
                        </div>
                        <div class="col-md-4">
                            <div class="detail-label">Course</div>
                            <div class="detail-value" id="reg-course"></div>
                        </div>
                    </div>

                    <div class="row detail-row">
                        <div class="col-md-4">
                            <div class="detail-label">Email</div>
                            <div class="detail-value" id="reg-email"></div>
                        </div>
                        <div class="col-md-4">
                            <div class="detail-label">Phone</div>
                            <div class="detail-value" id="reg-phone"></div>
                        </div>
                        <div class="col-md-4">
                            <div class="detail-label">College</div>
                            <div class="detail-value" id="reg-college"></div>
                        </div>
                    </div>

                    <div class="row detail-row">
                        <div class="col-md-4">
                            <div class="detail-label">Year</div>
                            <div class="detail-value" id="reg-year"></div>
                        </div>
                        <div class="col-md-4">
                            <div class="detail-label">Registration Date</div>
                            <div class="detail-value" id="reg-date"></div>
                        </div>
                        <div class="col-md-4">
                            <div class="detail-label">Last Updated</div>
                            <div class="detail-value" id="reg-updated"></div>
                        </div>
                    </div>

                    <!-- Team Information (shown only for team registrations) -->
                    <div id="team-info-section" style="display: none;">
                        <h6 class="mt-4 mb-3">Team Information</h6>
                        <div class="row detail-row">
                            <div class="col-md-4">
                                <div class="detail-label">Team Name</div>
                                <div class="detail-value" id="modal-team-name"></div>
                            </div>
                            <div class="col-md-4">
                                <div class="detail-label">Team Leader</div>
                                <div class="detail-value" id="modal-team-leader"></div>
                            </div>
                            <div class="col-md-4">
                                <div class="detail-label">Team Status</div>
                                <div class="detail-value" id="modal-team-status"></div>
                            </div>
                        </div>

                        <div class="row detail-row">
                            <div class="col-12">
                                <div class="detail-label">Team Members</div>
                                <div class="detail-value">
                                    <ul id="modal-team-members" class="list-group"></ul>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Payment Information -->
                    <h6 class="mt-4 mb-3">Payment Information</h6>
                    <div class="row detail-row">
                        <div class="col-md-4">
                            <div class="detail-label">Payment ID</div>
                            <div class="detail-value" id="reg-payment"></div>
                        </div>
                        <div class="col-md-4">
                            <div class="detail-label">Registration Mode</div>
                            <div class="detail-value" id="reg-mode"></div>
                        </div>
                        <div class="col-md-4">
                            <div class="detail-label">Status</div>
                            <div class="detail-value">
                                <select id="reg-status" class="form-select">
                                    <option value="Pending">Pending</option>
                                    <option value="Approved">Approved</option>
                                    <option value="Rejected">Rejected</option>
                                    <option value="Completed">Completed</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Pricing Details -->
                    <div class="row detail-row">
                        <div class="col-md-12">
                            <div class="detail-label">Pricing Details</div>
                            <!-- For Solo Registration -->
                            <div id="solo-pricing-details" style="display: none;">
                                <table class="table table-sm table-borderless mb-0">
                                    <tr>
                                        <td width="60%">Original Price:</td>
                                        <td><span id="solo-original-price"></span></td>
                                    </tr>
                                    <tr id="solo-discount-row" style="display: none;">
                                        <td>Discount (Referral):</td>
                                        <td><span id="solo-discount-amount"></span></td>
                                    </tr>
                                    <tr>
                                        <td><strong>Payable Amount:</strong></td>
                                        <td><strong><span id="solo-payable-amount"></span></strong></td>
                                    </tr>
                                </table>
                            </div>

                            <!-- For Team Registration -->
                            <div id="team-pricing-details" style="display: none;">
                                <table class="table table-sm table-borderless mb-0">
                                    <tr>
                                        <td width="60%">Original Price (per member):</td>
                                        <td><span id="team-price-per-member"></span></td>
                                    </tr>
                                    <tr>
                                        <td>Team Size:</td>
                                        <td><span id="team-size">5</span> members</td>
                                    </tr>
                                    <tr>
                                        <td>Subtotal (Original Price × Team Size):</td>
                                        <td><span id="team-subtotal"></span></td>
                                    </tr>
                                    <tr>
                                        <td>Team Discount:</td>
                                        <td><span id="team-discount"></span></td>
                                    </tr>
                                    <tr id="team-referral-row" style="display: none;">
                                        <td>Additional Discount (Referral):</td>
                                        <td><span id="team-referral-discount"></span></td>
                                    </tr>
                                    <tr>
                                        <td><strong>Final Payable Amount:</strong></td>
                                        <td><strong><span id="team-payable-amount"></span></strong></td>
                                    </tr>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Referral Information (shown only if referral code was used) -->
                    <div id="referral-info-section" style="display: none;">
                        <h6 class="mt-4 mb-3">Referral Information</h6>
                        <div class="row detail-row">
                            <div class="col-md-4">
                                <div class="detail-label">Referral Code</div>
                                <div class="detail-value" id="modal-referral-code"></div>
                            </div>
                            <div class="col-md-4">
                                <div class="detail-label">Referral Type</div>
                                <div class="detail-value" id="modal-referral-type"></div>
                            </div>
                            <div class="col-md-4">
                                <div class="detail-label">Discount Amount</div>
                                <div class="detail-value" id="modal-discount-amount"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Notes and Message -->
                    <h6 class="mt-4 mb-3">Notes and Message</h6>
                    <div class="row detail-row">
                        <div class="col-md-12">
                            <div class="detail-label">Message from Student</div>
                            <div class="detail-value" id="reg-message"></div>
                        </div>
                    </div>

                    <div class="row detail-row">
                        <div class="col-12">
                            <div class="detail-label">Admin Notes</div>
                            <textarea id="reg-notes" class="form-control" rows="3"></textarea>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="saveStatusBtn">Update Status</button>
                <button type="button" class="btn btn-success" id="saveNotesBtn">Save Notes</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block myjs %}

<!-- Load DataTables scripts in head -->
<script src="https://cdn.datatables.net/1.11.5/js/dataTables.bootstrap5.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.3/jszip.min.js"></script>
<script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.2.2/js/dataTables.buttons.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.2.2/js/buttons.html5.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/pdfmake.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/vfs_fonts.js"></script>

<script>

    $(document).ready(function () {
        // Initialize DataTable with server-side processing
        var table = $('#registrationsTable').DataTable({
            processing: true,
            serverSide: true, // We're handling pagination ourselves
            ajax: {
                url: `/administration/flames/registrations/ajax/`,
                data: function (d) {
                    // Pass all standard DataTables parameters (search, length, start, etc.)
                    d.course = $('#courseFilter').val();
                    d.status = $('#statusFilter').val();
                    d.year = $('#yearFilter').val();
                    d.college = $('#collegeFilter').val();
                    d.mode = $('#modeFilter').val();
                    console.log("Sending data:", d);
                },
                error: function (xhr, error, thrown) {
                    console.error("AJAX Error:", error, thrown);
                    console.log(xhr.responseText);

                    // Fallback to static data in case of AJAX error
                    alert("Error loading data. Please check the console for details.");

                    // Fallback: populate table with hard-coded data
                    var fallbackData = [
                        {
                            id: 1,
                            full_name: "Test Student",
                            course: { title: "Python Basics", color: "#4273FA" },
                            email: "test@example.com",
                            contact_number: "9876543210",
                            college: "Test College",
                            year: "3",
                            registration_mode: "SOLO",
                            team: "N/A",
                            created_at: "01 Jan 2023, 10:00 AM",
                            status: "Pending"
                        }
                    ];
                    table.clear();
                    table.rows.add(fallbackData);
                    table.draw();
                },
                dataSrc: function (json) {
                    return json.data || [];
                }
            },
            columns: [
                { data: "id" },
                { data: "full_name" },
                {
                    data: "course",
                    render: function (data) {
                        return `<span class="course-badge" style="background-color: ${data.color}20; color: ${data.color};">${data.title}</span>`;
                    }
                },
                /* { data: "email" }, */
                { data: "contact_number" },
                { data: "college" },
                { data: "year" },
                {
                    data: "registration_mode",
                    render: function (data) {
                        let modeClass = data === 'TEAM' ? 'status-approved' : 'status-pending';
                        return `<span class="status-badge ${modeClass}">${data}</span>`;
                    }
                },
                { data: "team" },
                { data: "created_at" },
                {
                    data: "status",
                    render: function (data) {
                        let statusClass = '';
                        switch (data) {
                            case 'Pending':
                                statusClass = 'status-pending';
                                break;
                            case 'Approved':
                                statusClass = 'status-approved';
                                break;
                            case 'Rejected':
                                statusClass = 'status-rejected';
                                break;
                            case 'Completed':
                                statusClass = 'status-completed';
                                break;
                        }
                        return `<span class="status-badge ${statusClass}">${data}</span>`;
                    }
                },
                {
                    data: "id",
                    render: function (data) {
                        return `<button class="btn btn-sm btn-primary view-details" data-id="${data}"><i class="fas fa-eye"></i></button>`;
                    },
                    orderable: false
                }
            ],
            createdRow: function (row, data, dataIndex) {
                // Add data-id attribute to the row for easy row identification
                $(row).attr('data-id', data.id);
            },
            responsive: true,
            order: [[7, 'desc']], // Sort by registration date (newest first)
            lengthMenu: [[10, 25, 50, 100, -1], [10, 25, 50, 100, "All"]],
            pageLength: 50, // Set default page length to 50 entries
            dom: '<"d-flex justify-content-between align-items-center mb-3"lf>rt<"d-flex justify-content-between align-items-center mt-3"ip>',
            language: {
                search: "_INPUT_",
                searchPlaceholder: "Search registrations...",
                lengthMenu: "Show _MENU_ entries",
                processing: "<div class='spinner-border text-primary' role='status'><span class='visually-hidden'>Loading...</span></div>"
            },
            initComplete: function () {
                console.log("DataTable initialization complete");
                // Apply event handlers after table is initialized
                attachEventHandlers();
            }
        });

        console.log("DataTable initialized");

        // Apply filters when form is submitted
        $('#filterForm').on('submit', function (e) {
            e.preventDefault();
            console.log("Filter form submitted");
            // Clear any client-side search, keep only server-side filtering
            table.search('').columns().search('');
            table.ajax.reload();
        });

        // Reset filters
        $('#resetFilters').on('click', function () {
            $('#filterForm')[0].reset();
            console.log("Filters reset");
            // Also clear DataTable search
            table.search('').columns().search('');
            table.ajax.reload();
        });

        // Add event listeners to handle proper search integration
        $('.dataTables_filter input').on('keyup', function () {
            // Add a slight delay to prevent excessive requests
            clearTimeout($.data(this, 'timer'));
            var timer = setTimeout(function () {
                console.log("Search triggered");
                table.ajax.reload();
            }, 500);
            $(this).data('timer', timer);
        });

        // Attach event handlers for dynamic elements
        function attachEventHandlers() {
            console.log("Attaching event handlers");
            // Handle row click to show registration details
            $('#registrationsTable tbody').on('click', 'tr', function () {
                const data = table.row(this).data();
                const id = data.id;

                $.ajax({
                    url: "{% url 'admin_registration_details' %}",
                    method: 'GET',
                    data: { 'id': id },
                    success: function (response) {
                        if (response.status === 'success') {
                            const reg = response.data;

                            // Populate modal with registration details
                            $('#reg-id').text(reg.id);
                            $('#reg-name').text(reg.name);
                            $('#reg-course').text(reg.course_title);
                            $('#reg-email').text(reg.email);
                            $('#reg-phone').text(reg.phone);
                            $('#reg-college').text(reg.college);
                            $('#reg-year').text(reg.year);
                            $('#reg-date').text(reg.created_at);
                            $('#reg-updated').text(reg.updated_at);
                            $('#reg-status').val(reg.status); // Use val() for select element
                            $('#reg-payment').text(reg.payment_id || 'N/A');
                            $('#reg-message').text(reg.message || 'No message');
                            $('#reg-notes').val(reg.admin_notes || '');

                            // Display registration mode
                            $('#reg-mode').text(reg.registration_mode === 'TEAM' ? 'Team Registration' : 'Solo Registration');

                            // Handle team information and pricing display
                            const isTeam = reg.registration_mode === 'TEAM';

                            // Format currency function
                            const formatCurrency = (amount) => {
                                return '₹' + parseFloat(amount).toLocaleString('en-IN');
                            };

                            // Show/hide pricing details based on registration mode
                            if (isTeam) {
                                $('#solo-pricing-details').hide();
                                $('#team-pricing-details').show();

                                // Calculate team pricing details
                                const originalPrice = parseFloat(reg.payment.original_price);
                                const payableAmount = parseFloat(reg.payable_amount || reg.payment.actual_amount_to_pay);
                                const teamSize = 5; // Fixed team size
                                const subtotal = originalPrice * teamSize;
                                const teamDiscount = 499 * teamSize; // Fixed discount of 499 per member

                                // Display team pricing breakdown
                                $('#team-price-per-member').text(formatCurrency(originalPrice));
                                $('#team-subtotal').text(formatCurrency(subtotal));
                                $('#team-discount').text(formatCurrency(teamDiscount));
                                $('#team-payable-amount').text(formatCurrency(payableAmount));

                                // Handle referral discount if applicable
                                if (reg.referral && reg.referral.is_referral) {
                                    const referralDiscount = parseFloat(reg.referral.actual_discount_amount);
                                    $('#team-referral-discount').text(formatCurrency(referralDiscount));
                                    $('#team-referral-row').show();
                                } else {
                                    $('#team-referral-row').hide();
                                }

                                // Show team member information
                                $('#team-info-section').show();
                                $('#modal-team-name').text(reg.team.name || 'N/A');
                                $('#modal-team-leader').text(reg.team.leader_name || 'N/A');
                                $('#modal-team-status').text(reg.team.status || 'N/A');

                                // Clear previous team members
                                $('#modal-team-members').empty();

                                // Add team members to the list
                                if (reg.team.members && reg.team.members.length > 0) {
                                    reg.team.members.forEach(function (member) {
                                        const memberItem = $('<li class="list-group-item"></li>');
                                        const leaderBadge = member.is_leader ?
                                            ' <span class="badge bg-primary ms-2">Leader</span>' : '';
                                        memberItem.html(member.name + ' (' + member.email + ')' + leaderBadge);
                                        $('#modal-team-members').append(memberItem);
                                    });
                                } else {
                                    $('#modal-team-members').append('<li class="list-group-item">No team members found</li>');
                                }
                            } else {
                                // Solo registration pricing
                                $('#team-pricing-details').hide();
                                $('#solo-pricing-details').show();
                                $('#team-info-section').hide();

                                const originalPrice = parseFloat(reg.payment.original_price);
                                const payableAmount = parseFloat(reg.payable_amount || reg.payment.actual_amount_to_pay);

                                $('#solo-original-price').text(formatCurrency(originalPrice));
                                $('#solo-payable-amount').text(formatCurrency(payableAmount));

                                // Handle referral discount for solo registration
                                if (reg.referral && reg.referral.is_referral) {
                                    const referralDiscount = parseFloat(reg.referral.discount_amount);
                                    $('#solo-discount-amount').text(formatCurrency(referralDiscount));
                                    $('#solo-discount-row').show();
                                } else {
                                    $('#solo-discount-row').hide();
                                }
                            }

                            // Referral Information (if applicable)
                            if (reg.referral_code) {
                                $('#referral-info-section').show();
                                $('#modal-referral-code').text(reg.referral_code || 'N/A');
                                $('#modal-referral-type').text(reg.referral_type || 'N/A');
                                $('#modal-discount-amount').text(reg.discount_amount ? '₹' + reg.discount_amount : 'N/A');
                            } else {
                                $('#referral-info-section').hide();
                            }

                            // Store the registration ID for update actions
                            $('#saveStatusBtn').data('id', reg.id);
                            $('#saveNotesBtn').data('id', reg.id);

                            // Show the modal
                            $('#registrationDetailsModal').modal('show');
                        } else {
                            alert('Error: ' + response.message);
                        }
                    },
                    error: function () {
                        alert('An error occurred while fetching registration details.');
                    }
                });
            });

            // Quick approve/reject handlers for table buttons
            $('#registrationsTable').on('click', '.approve-reg', function () {
                var regId = $(this).data('id');
                console.log("Approve clicked for ID:", regId);
                updateRegistrationStatus(regId, 'approved');
            });

            $('#registrationsTable').on('click', '.reject-reg', function () {
                var regId = $(this).data('id');
                console.log("Reject clicked for ID:", regId);
                updateRegistrationStatus(regId, 'rejected');
            });
        }

        // Helper function to get ordinal suffix
        function getOrdinalSuffix(n) {
            var s = ["th", "st", "nd", "rd"];
            var v = n % 100;
            return (s[(v - 20) % 10] || s[v] || s[0]);
        }

        // Handle registration status update
        function updateRegistrationStatus(id, status) {
            $.ajax({
                url: '{% url "admin_update_registration_status" %}',
                type: 'POST',
                data: {
                    'id': id,
                    'status': status,
                    'csrfmiddlewaretoken': '{{ csrf_token }}'
                },
                success: function (response) {
                    if (response.status === 'success') {
                        $('#registrationDetailsModal').modal('hide');
                        table.ajax.reload();
                    } else {
                        alert('Error: ' + response.message);
                    }
                },
                error: function () {
                    alert('An error occurred while updating the status.');
                }
            });
        }

        // Save status button click handler
        $('#saveStatusBtn').on('click', function () {
            const id = $(this).data('id');
            const status = $('#reg-status').val();

            $.ajax({
                url: "{% url 'admin_update_registration_status' %}",
                method: 'POST',
                data: {
                    'id': id,
                    'status': status,
                    'csrfmiddlewaretoken': '{{ csrf_token }}'
                },
                success: function (response) {
                    if (response.status === 'success') {
                        $('#registrationDetailsModal').modal('hide');
                        table.ajax.reload();
                    } else {
                        alert('Error: ' + response.message);
                    }
                },
                error: function () {
                    alert('An error occurred while updating the status.');
                }
            });
        });

        // Save notes button click handler
        $('#saveNotesBtn').on('click', function () {
            const id = $(this).data('id');
            const notes = $('#reg-notes').val();

            $.ajax({
                url: "{% url 'admin_update_registration_notes' %}",
                method: 'POST',
                data: {
                    'id': id,
                    'notes': notes,
                    'csrfmiddlewaretoken': '{{ csrf_token }}'
                },
                success: function (response) {
                    if (response.status === 'success') {
                        alert('Notes updated successfully!');
                    } else {
                        alert('Error: ' + response.message);
                    }
                },
                error: function () {
                    alert('An error occurred while updating the notes.');
                }
            });
        });

        // Function to update admin notes
        function updateAdminNotes(regId, notes) {
            $.ajax({
                url: '{% url "admin_update_registration_notes" %}',
                type: 'POST',
                data: {
                    'id': regId,
                    'notes': notes,
                    'csrfmiddlewaretoken': '{{ csrf_token }}'
                },
                success: function (response) {
                    if (response.status === 'success') {
                        alert('Notes updated successfully');
                    } else {
                        alert('Error: ' + response.message);
                    }
                },
                error: function () {
                    alert('An error occurred while updating notes.');
                }
            });
        }

        // Export buttons functionality
        $('#exportExcel').on('click', function () {
            // Get current filtered data
            var filteredData = table.rows({ search: 'applied' }).data().toArray();

            // Create a new instance of Buttons for export with current filtered data
            var tempTable = $('<table></table>').DataTable({
                data: filteredData,
                columns: [
                    { data: "id", title: "ID" },
                    { data: "full_name", title: "Name" },
                    { data: "course.title", title: "Course" },
                    { data: "email", title: "Email" },
                    { data: "contact_number", title: "Phone" },
                    { data: "college", title: "College" },
                    { data: "year", title: "Year" },
                    { data: "created_at", title: "Registration Date" },
                    { data: "status", title: "Status" }
                ],
                dom: 'Bfrtip',
                buttons: [
                    {
                        extend: 'excel',
                        text: 'Export to Excel',
                        title: 'FLAMES Registrations - ' + new Date().toLocaleDateString(),
                        className: 'hidden'
                    }
                ]
            });

            // Trigger the export
            tempTable.button('.hidden').trigger();

            // Clean up
            tempTable.destroy();
        });

        $('#exportPDF').on('click', function () {
            // Get current filtered data
            var filteredData = table.rows({ search: 'applied' }).data().toArray();

            // Create a new instance of Buttons for export with current filtered data
            var tempTable = $('<table></table>').DataTable({
                data: filteredData,
                columns: [
                    { data: "id", title: "ID" },
                    { data: "full_name", title: "Name" },
                    { data: "course.title", title: "Course" },
                    { data: "email", title: "Email" },
                    { data: "contact_number", title: "Phone" },
                    { data: "college", title: "College" },
                    { data: "year", title: "Year" },
                    { data: "created_at", title: "Registration Date" },
                    { data: "status", title: "Status" }
                ],
                dom: 'Bfrtip',
                buttons: [
                    {
                        extend: 'pdf',
                        text: 'Export to PDF',
                        title: 'FLAMES Registrations - ' + new Date().toLocaleDateString(),
                        className: 'hidden',
                        orientation: 'landscape',
                        pageSize: 'A4'
                    }
                ]
            });

            // Trigger the export
            tempTable.button('.hidden').trigger();

            // Clean up
            tempTable.destroy();
        });
    });
</script>

{% endblock %}