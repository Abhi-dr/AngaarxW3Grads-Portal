{% extends "administration/base.html" %}
{% load static %}

{% block title %}
Edit Sheet | {{ sheet.name }}
{% endblock %}

{% block sheet_active %}
active
{% endblock %}

{% block body %}

<div class="container-fluid">
    {% for message in messages %}

    <div class="alert {{ message.tags }} alert-dismissible fade show" role="alert">
        <strong>{{ message.tag }}</strong> {{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>

    {% endfor %}

    <div class="card">
        <div class="card-body">
            <h5 class="card-title fw-semibold mb-0">Edit {{ sheet.name }}</i> </h5>

        </div>
        <div class="container px-4">
            <form method="POST" enctype="multipart/form-data">
                {% csrf_token %}

                <hr class="mt-0">
                <div class="row">

                    <div class="w-100">
                        <div class="card-body h-100">

                            <div>
                                <div class="mb-3">
                                    <label for="assignment_type" class="form-label">Batches
                                    </label>
                                    <select class="form-select form-control" name="batches" id="assignment_type"
                                        multiple>
                                        {% for batch in batches %}
                                        <option value="{{ batch.id }}" {% if batch.id in selected_batch_ids %}selected{%endif %}>
                                            {{ batch.name }}
                                        </option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>

                            <div class="mb-3">
                                <label for="sheet_type" class="form-label">Sheet Type</label>
                                <select class="form-select form-control" name="sheet_type" id="sheet_type" required>
                                    <option value="Coding" {% if sheet.sheet_type == 'Coding' %}selected{% endif %}>
                                        Coding Problems
                                    </option>
                                    <option value="MCQ" {% if sheet.sheet_type == 'MCQ' %}selected{% endif %}>
                                        Multiple Choice Questions
                                    </option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="job_title" class="form-label">Name
                                    <div class="star">*</div>
                                </label>
                                <input type="text" class="form-control" id="question_title" name="name"
                                    placeholder="Name goes here..." value="{{ sheet.name }}" required>
                            </div>

                            <div class="row">
                                <div class="mb-3 col-md-9">
                                    <label for="thumbnail" class="form-label">Thumbnail</label>
                                    <input type="file" class="form-control" id="thumbnailInput" name="thumbnail">
                                </div>

                                <div class="mb-3 col-md-3">
                                    <img src="{{ sheet.thumbnail.url }}" alt="thumbnail" class="img-thumbnail"
                                        style="height: 100px;">
                                </div>
                            </div>

                            <div>
                                <div class="form-check">
                                    <label class="form-check-label" for="isSample">Is It Sequential?</label>

                                    {% if sheet.is_sequential %}

                                    <input type="checkbox" checked class="form-check-input" id="isSample"
                                        name="is_sequential">

                                    {% else %}

                                    <input type="checkbox" class="form-check-input" id="isSample" name="is_sequential">

                                    {% endif %}
                                </div>
                            </div>

                            <div>
                                <div class="col-md-12">
                                    <button type="submit" class="btn btn-success w-100 mt-3">EDIT &nbsp; Sheet</button>
                                </div>
                            </div>
                        </div>

                    </div>

                </div>
        </div>

        </form>

        <div class="modal fade" id="cropperModal" tabindex="-1" aria-labelledby="cropperModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="cropperModalLabel">Crop Image</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="img-container">
                            <img id="image" style="max-width: 100%;" />
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-primary" id="cropButton">Crop</button>
                    </div>
                </div>
            </div>
        </div>

    </div>
</div>


<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.css">

<script>
    $(document).ready(function () {
        let cropper;
        const thumbnailInput = document.getElementById('thumbnailInput');
        const image = document.getElementById('image');
        const cropperModal = new bootstrap.Modal(document.getElementById('cropperModal'));
        const cropButton = document.getElementById('cropButton');

        // Trigger modal on file selection
        thumbnailInput.addEventListener('change', function (e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function (event) {
                    image.src = event.target.result;
                    cropperModal.show();
                };
                reader.readAsDataURL(file);
            }
        });

        // Initialize Cropper.js when modal is shown
        $('#cropperModal').on('shown.bs.modal', function () {
            cropper = new Cropper(image, {
                aspectRatio: 5 / 4, // Fixed Aspect Ratio
                viewMode: 1, // Restrict the crop box to not exceed the size of the canvas
                dragMode: 'move', // Allow only moving the crop box
                cropBoxResizable: true, // Disable resizing
                cropBoxMovable: true // Allow moving
            });
        }).on('hidden.bs.modal', function () {
            if (cropper) {
                cropper.destroy();
                cropper = null;
            }
        });

        // Handle crop button click
        cropButton.addEventListener('click', function () {
            if (cropper) {
                const croppedImage = cropper.getCroppedCanvas().toDataURL('image/png');
                // Convert base64 to a file object and set it as the input value
                const blob = dataURLtoBlob(croppedImage);

                // Dynamically name the cropped file based on the original image name
                const fileName = thumbnailInput.files[0].name; // Get the original file name
                const fileExtension = fileName.substring(fileName.lastIndexOf('.')); // Extract the file extension
                const croppedFileName = fileName.replace(fileExtension, '') + "-cropped" + fileExtension; // Append "-cropped"
                const file = new File([blob], croppedFileName, { type: "image/png" });

                const dataTransfer = new DataTransfer();
                dataTransfer.items.add(file);
                thumbnailInput.files = dataTransfer.files;
                cropperModal.hide();
            }
        });


        // Convert base64 to blob
        function dataURLtoBlob(dataurl) {
            const arr = dataurl.split(','), mime = arr[0].match(/:(.*?);/)[1];
            const bstr = atob(arr[1]);
            let n = bstr.length;
            const u8arr = new Uint8Array(n);
            while (n--) {
                u8arr[n] = bstr.charCodeAt(n);
            }
            return new Blob([u8arr], { type: mime });
        }
    });
</script>


{% endblock %}