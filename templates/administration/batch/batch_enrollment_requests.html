{% extends "administration/base.html" %}
{% load static %}

{% block title %}
{{ batch.name }} | Enrollments
{% endblock %}

{% block my_batches_active %}
active
{% endblock %}

{% block body %}

<div class="container-fluid">
    <div class="card">
        <div class="card-body d-flex align-items-center">
            <h3 class="heading mb-0">
                <span class="fw-semibold">&nbsp;Enrollments: (<span id="totalEnrollments">0</span>)</span>
            </h3>
            <!-- optional search kept -->
            <form class="ms-auto d-flex" id="searchForm" onsubmit="event.preventDefault(); filterEnrollments();">
                <input type="text" id="queryInput" class="form-control form-control-sm me-2"
                    placeholder="Search by ID, Name, Email or Phone" oninput="filterEnrollments()" />
                <button class="btn btn-outline-secondary btn-sm" type="submit">Search</button>
            </form>
        </div>
    </div>

    {% for message in messages %}
    <div class="alert {{ message.tags }} alert-dismissible fade show" role="alert">
        <strong>{{ message.tag }}</strong> {{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
    {% endfor %}

    <div class="card w-100">
        <div class="card-body p-4">
            <h5 class="card-title fw-semibold mb-4">Enrollments ðŸ”¥
                <span class="fs-6" id="searchInfo"></span>
            </h5>

            <div class="table-responsive">
                <table class="table text-nowrap mb-0 align-middle">
                    <thead class="text-dark fs-4">
                        <tr>
                            <th class="border-bottom-0">
                                <h6 class="fw-semibold mb-0">#</h6>
                            </th>
                            <th class="border-bottom-0">
                                <h6 class="fw-semibold mb-0">Name</h6>
                            </th>
                            <th class="border-bottom-0">
                                <h6 class="fw-semibold mb-0">Additional Data</h6>
                            </th>
                            <th class="border-bottom-0">
                                <h6 class="fw-semibold mb-0">Status</h6>
                            </th>
                            <th class="border-bottom-0">
                                <h6 class="fw-semibold mb-0">Enrolled On</h6>
                            </th>
                            <th class="border-bottom-0">
                                <h6 class="fw-semibold mb-0">Actions</h6>
                            </th>
                        </tr>
                    </thead>
                    <tbody id="enrollmentTableBody">
                        <!-- rows populated by JS -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
    let allEnrollments = [];

    document.addEventListener("DOMContentLoaded", function () {
        fetchEnrollments();
    });

    /*
      NOTE:
      - Replace the fetch URL below with your actual API endpoint that returns
        enrollments for the batch. The expected JSON format used here is:
        { data: [ { id, student_name, additional_data (object), status, enrolled_date } ] }
    */

    function fetchEnrollments() {
        const url = "{% url 'administrator_fetch_enrollments_of_batch' batch.slug %}";

        fetch(url)
            .then(resp => {
                if (!resp.ok) throw new Error('Network response was not ok');
                return resp.json();
            })
            .then(data => {
                allEnrollments = data.data || [];
                // Pre-parse additional data for all records once
                allEnrollments.forEach(student => {
                    let additional_data = student.additional_data || {};
                    if (typeof additional_data === 'string') {
                        try { additional_data = JSON.parse(additional_data); } catch (e) { }
                    }
                    student.parsed_additional_data = additional_data;
                });

                document.getElementById('totalEnrollments').textContent = allEnrollments.length;
                filterEnrollments(); // Display initial data
            })
            .catch(err => {
                console.error("Error fetching enrollments:", err);
            });
    }

    function rejectEnrollment(id) {
        if (!confirm("Are you sure you want to reject this enrollment?")) return;

        const url = "{% url 'administrator_reject_enrollment_batch' 0 %}".replace('0', id);

        fetch(url, {
            method: 'GET', // or POST if your view expects it, but the view seems to handle GET/AJAX
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
            .then(resp => resp.json())
            .then(data => {
                if (data.success) {
                    // Remove the student from the local array
                    allEnrollments = allEnrollments.filter(s => s.id != id);
                    // Re-filter and display
                    filterEnrollments();
                    document.getElementById('totalEnrollments').textContent = allEnrollments.length;

                    // Optional: Show success toast/alert
                } else {
                    alert("Error: " + (data.message || "Could not reject enrollment"));
                }
            })
            .catch(err => {
                console.error("Error rejecting enrollment:", err);
                alert("An error occurred while rejecting.");
            });
    }

    function filterEnrollments() {
        const query = document.getElementById('queryInput')?.value.toLowerCase().trim() || '';

        const filtered = allEnrollments.filter(student => {
            if (!query) return true;

            // Check main fields
            const name = (student.student_name || '').toLowerCase();
            const email = (student.email || '').toLowerCase();
            const phone = (student.phone || '').toLowerCase();
            const id = String(student.id || '').toLowerCase();

            if (name.includes(query) || email.includes(query) || phone.includes(query) || id.includes(query)) {
                return true;
            }

            // Optional: Check inside additional data values as well?
            // If the user wants to search "College Name", this would be useful.
            // Let's include it for a better experience.
            const additional = student.parsed_additional_data || {};
            for (let key in additional) {
                if (String(additional[key]).toLowerCase().includes(query)) {
                    return true;
                }
            }

            return false;
        });

        display_enrollments(filtered);

        const searchInfo = document.getElementById('searchInfo');
        searchInfo.textContent = query ? ` | Search Results for "${query}"` : '';
    }

    function display_enrollments(enrollments) {
        const tbody = document.getElementById('enrollmentTableBody');
        const theadRow = document.querySelector('table thead tr');
        tbody.innerHTML = '';

        // 1. Determine all unique additional keys from the FILTERED list
        let allKeys = new Set();
        enrollments.forEach(student => {
            // parsed_additional_data is already set in fetchEnrollments
            const additional_data = student.parsed_additional_data || {};
            Object.keys(additional_data).forEach(k => allKeys.add(k));
        });
        const sortedKeys = Array.from(allKeys).sort();

        // 2. Update Header
        // Base headers: #, Name
        let headerHtml = `
            <th class="border-bottom-0"><h6 class="fw-semibold mb-0">#</h6></th>
            <th class="border-bottom-0"><h6 class="fw-semibold mb-0">Name</h6></th>
        `;

        // Dynamic headers
        sortedKeys.forEach(key => {
            // Capitalize first letter for display
            const label = key.charAt(0).toUpperCase() + key.slice(1);
            headerHtml += `<th class="border-bottom-0"><h6 class="fw-semibold mb-0">${label}</h6></th>`;
        });

        // End headers: Status, Enrolled On, Actions
        headerHtml += `
            <th class="border-bottom-0"><h6 class="fw-semibold mb-0">Status</h6></th>
            <th class="border-bottom-0"><h6 class="fw-semibold mb-0">Enrolled On</h6></th>
            <th class="border-bottom-0"><h6 class="fw-semibold mb-0">Actions</h6></th>
        `;

        if (theadRow) {
            theadRow.innerHTML = headerHtml;
        }

        // 3. Render Rows
        enrollments.forEach((student, index) => {
            const tr = document.createElement('tr');
            const additional_data = student.parsed_additional_data || {};

            let dynamicCells = '';
            sortedKeys.forEach(key => {
                const val = additional_data[key] !== undefined ? additional_data[key] : 'â€”';
                dynamicCells += `<td style="text-align: left;"><p class="fw-semibold mb-1 text-wrap">${val}</p></td>`;
            });

            // Actions column
            const actionsHtml = `
                <button class="btn btn-sm btn-outline-danger" onclick="rejectEnrollment(${student.id})">Reject</button>
            `;

            tr.innerHTML = `
            <td>${index + 1}</td>
            <td><h6 class="fw-semibold mb-1 text-wrap">${student.student_name || 'â€“'}</h6></td>
            ${dynamicCells}
            <td style="text-align: center;"><span class="badge bg-${student.status_color || 'secondary'}">${student.status || 'Enrolled'}</span></td>
            <td style="text-align: center;"><p class="fw-semibold mb-1 text-wrap">${student.enrolled_date || 'â€”'}</p></td>
            <td style="text-align: center;">
                ${actionsHtml}
            </td>
        `;

            tbody.appendChild(tr);
        });
    }
</script>

{% endblock %}